# –ü–∞–π–ø–ª–∞–π–Ω –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

## üìã –û–±–∑–æ—Ä

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Å–∏—Å—Ç–µ–º—É Neuro_Doc_Assistant, –≤–∫–ª—é—á–∞—è –∑–∞–≥—Ä—É–∑–∫—É –≤ S3, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –≤ Qdrant.

---

## üîÑ –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### –°—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              –ü–ê–ô–ü–õ–ê–ô–ù –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ù–û–í–´–• –î–û–ö–£–ú–ï–ù–¢–û–í                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. –ó–ê–ì–†–£–ó–ö–ê –í S3 (MinIO / SberCloud Object Storage)
   ‚îÇ
   ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
   ‚îú‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ S3 bucket
   ‚îî‚îÄ –ü–æ–ª—É—á–µ–Ω–∏–µ S3 –∫–ª—é—á–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "hr/hr_new_doc.md")
   ‚îÇ
   ‚ñº
2. –°–û–•–†–ê–ù–ï–ù–ò–ï –ú–ï–¢–ê–î–ê–ù–ù–´–• –í POSTGRESQL
   ‚îÇ
   ‚îú‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ documents
   ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: file_path, s3_key, category, filename
   ‚îú‚îÄ –°—Ç–∞—Ç—É—Å: indexed_at = NULL (–µ—â–µ –Ω–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω)
   ‚îî‚îÄ –í–µ—Ä—Å–∏—è: version = 1
   ‚îÇ
   ‚ñº
3. –ó–ê–ì–†–£–ó–ö–ê –ò –ü–ê–†–°–ò–ù–ì –î–û–ö–£–ú–ï–ù–¢–ê
   ‚îÇ
   ‚îú‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ S3 —á–µ—Ä–µ–∑ DocumentLoader
   ‚îú‚îÄ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
   ‚îî‚îÄ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
   ‚îÇ
   ‚ñº
4. –ß–ê–ù–ö–ò–ù–ì
   ‚îÇ
   ‚îú‚îÄ –†–∞–∑–±–∏–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ —á–∞–Ω–∫–∏
   ‚îú‚îÄ –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞: CHUNK_SIZE (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 300 —Ç–æ–∫–µ–Ω–æ–≤)
   ‚îî‚îÄ Overlap: CHUNK_OVERLAP_PERCENT (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 25%)
   ‚îÇ
   ‚ñº
5. –ì–ï–ù–ï–†–ê–¶–ò–Ø EMBEDDINGS
   ‚îÇ
   ‚îú‚îÄ –†–µ–∂–∏–º: GigaChat Embeddings API –∏–ª–∏ Mock
   ‚îú‚îÄ –ë–∞—Ç—á–∏–Ω–≥ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
   ‚îî‚îÄ –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞
   ‚îÇ
   ‚ñº
6. –ò–ù–î–ï–ö–°–ê–¶–ò–Ø –í QDRANT
   ‚îÇ
   ‚îú‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—á–µ–∫ (points) —Å –≤–µ–∫—Ç–æ—Ä–∞–º–∏ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
   ‚îú‚îÄ Batch upsert –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ chunk_id –≤ payload
   ‚îÇ
   ‚ñº
7. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ú–ï–¢–ê–î–ê–ù–ù–´–• –í POSTGRESQL
   ‚îÇ
   ‚îú‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ indexed_at = NOW()
   ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ embedding_mode –∏ embedding_dim
   ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≤—è–∑–∏ —á–∞–Ω–∫–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ chunks
   ‚îî‚îÄ –°—Ç–∞—Ç—É—Å: –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω ‚úÖ
```

---

## üìù –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —ç—Ç–∞–ø–æ–≤

### –≠—Ç–∞–ø 1: –ó–∞–≥—Ä—É–∑–∫–∞ –≤ S3

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `S3DocumentStorage.upload_document()`

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –ª–æ–∫–∞–ª—å–Ω–æ
2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è S3 –∫–ª—é—á–∞ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω): `{category}/{filename}`
3. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ S3 bucket
4. –í–æ–∑–≤—Ä–∞—Ç S3 URI: `s3://bucket/key`

**–ü—Ä–∏–º–µ—Ä:**
```python
from app.storage.s3_storage import S3DocumentStorage
from pathlib import Path

storage = S3DocumentStorage()
s3_uri = storage.upload_document(
    file_path=Path("data/new_doc.md"),
    object_key="hr/hr_new_policy.md"
)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: s3://neuro-doc-docs/hr/hr_new_policy.md
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ S3, –æ–Ω –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: `.md`, `.txt`, `.pdf`, `.docx`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ bucket, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

---

### –≠—Ç–∞–ø 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `DocumentRepository.save_document()`

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ `s3_key`
2. –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
3. –ï—Å–ª–∏ –Ω–æ–≤—ã–π - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `documents`
4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `indexed_at = NULL` (–¥–æ–∫—É–º–µ–Ω—Ç –µ—â–µ –Ω–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω)

**–ü—Ä–∏–º–µ—Ä:**
```python
from app.storage.document_repository import DocumentRepository, DocumentMetadata

repo = DocumentRepository()
metadata = DocumentMetadata(
    file_path="/local/path/to/new_doc.md",
    s3_key="hr/hr_new_policy.md",
    category="hr",
    filename="hr_new_policy.md",
    file_size=1024,
    mime_type="text/markdown"
)
doc_id = repo.save_document(metadata)
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø–∏—Å–∏ –≤ –ë–î:**
```sql
INSERT INTO documents (
    file_path, s3_key, category, filename, 
    file_size, mime_type, created_at, indexed_at
) VALUES (
    '/local/path/to/new_doc.md',
    'hr/hr_new_policy.md',
    'hr',
    'hr_new_policy.md',
    1024,
    'text/markdown',
    NOW(),
    NULL  -- –ï—â–µ –Ω–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω
);
```

---

### –≠—Ç–∞–ø 3: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ –¥–æ–∫—É–º–µ–Ω—Ç–∞

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `DocumentLoader.load_documents()`

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∏–∑ S3
2. –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ UTF-8
3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (—É–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤)
4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–∫–∞—Ç–µ–≥–æ—Ä–∏—è, –∏–º—è —Ñ–∞–π–ª–∞)

**–ü—Ä–∏–º–µ—Ä:**
```python
from app.ingestion.loader import DocumentLoader

loader = DocumentLoader(storage_backend="s3")
documents = loader.load_documents("hr/hr_new_policy.md", category="hr")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ `Document` —Å –ø–æ–ª—è–º–∏:
  - `id`: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
  - `text`: –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
  - `metadata`: —Å–ª–æ–≤–∞—Ä—å —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏

---

### –≠—Ç–∞–ø 4: –ß–∞–Ω–∫–∏–Ω–≥

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `Chunker.chunk_documents()`

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –†–∞–∑–±–∏–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —á–∞–Ω–∫–∏ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ overlap –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏
3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `chunk_size`: —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ –≤ —Ç–æ–∫–µ–Ω–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 300)
- `overlap_percent`: –ø—Ä–æ—Ü–µ–Ω—Ç –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 25%)

**–ü—Ä–∏–º–µ—Ä:**
```python
from app.ingestion.chunker import Chunker

chunker = Chunker()
chunks = chunker.chunk_documents(
    documents,
    chunk_size=300,
    overlap_percent=0.25
)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ `Chunk` —Å –ø–æ–ª—è–º–∏:
  - `text`: —Ç–µ–∫—Å—Ç —á–∞–Ω–∫–∞
  - `metadata`: –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (doc_id, chunk_index, etc.)

---

### –≠—Ç–∞–ø 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Embeddings

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `EmbeddingService.generate_embeddings()`

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã (GigaChat API –∏–ª–∏ Mock)
2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è embeddings –±–∞—Ç—á–∞–º–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (429, 402) —Å fallback –Ω–∞ mock mode

**–†–µ–∂–∏–º—ã:**
- **GigaChat API**: —Ä–µ–∞–ª—å–Ω—ã–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ embeddings
- **Mock**: –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ–∫—Ç–æ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ MD5 hash

**–ü—Ä–∏–º–µ—Ä:**
```python
from app.ingestion.embedding_service import EmbeddingService

embedding_service = EmbeddingService(
    model_version="GigaChat",
    embedding_dim=1024,
    mock_mode=False
)
embeddings = embedding_service.generate_embeddings(
    [chunk.text for chunk in chunks]
)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–ø–∏—Å–æ–∫ –≤–µ–∫—Ç–æ—Ä–æ–≤ (—Å–ø–∏—Å–∫–æ–≤ —á–∏—Å–µ–ª) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞
- –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å: 1024 (GigaChat) –∏–ª–∏ 1536 (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ)

---

### –≠—Ç–∞–ø 6: –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ Qdrant

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `QdrantIndexer.index_chunks()`

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—á–µ–∫ (points) —Å –≤–µ–∫—Ç–æ—Ä–∞–º–∏ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
2. Batch upsert –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ø–æ 100 —Ç–æ—á–µ–∫)
3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é `neuro_docs`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–æ—á–∫–∏ –≤ Qdrant:**
```python
{
    "id": "chunk_id_123",
    "vector": [0.1, 0.2, ...],  # embedding –≤–µ–∫—Ç–æ—Ä
    "payload": {
        "text": "—Ç–µ–∫—Å—Ç —á–∞–Ω–∫–∞",
        "doc_id": "doc_123",
        "chunk_id": "chunk_id_123",
        "source": "hr",
        "created_at": "2024-12-19T10:00:00",
        "text_length": 250,
        "embedding_version": "gigachat_api"
    }
}
```

**–ü—Ä–∏–º–µ—Ä:**
```python
from app.ingestion.indexer import QdrantIndexer

indexer = QdrantIndexer(
    qdrant_client=qdrant_client,
    collection_name="neuro_docs",
    embedding_dim=1024
)
indexer.index_chunks(chunks, embeddings)
```

---

### –≠—Ç–∞–ø 7: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `DocumentRepository.mark_as_indexed()`

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `indexed_at = NOW()`
2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `embedding_mode` –∏ `embedding_dim`
3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≤—è–∑–∏ —á–∞–Ω–∫–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ `chunks`

**–ü—Ä–∏–º–µ—Ä:**
```python
repo.mark_as_indexed(
    s3_key="hr/hr_new_policy.md",
    embedding_mode="gigachat_api",
    embedding_dim=1024
)
```

**SQL –∑–∞–ø—Ä–æ—Å:**
```sql
UPDATE documents 
SET 
    indexed_at = NOW(),
    embedding_mode = 'gigachat_api',
    embedding_dim = 1024
WHERE s3_key = 'hr/hr_new_policy.md';
```

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤:**
```sql
INSERT INTO chunks (
    document_id, chunk_id, chunk_index, 
    text_preview, text_length, embedding_version
) VALUES (
    'doc_uuid', 'chunk_1', 0,
    '–ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤...', 250, 'gigachat_api'
);
```

---

## üîÑ –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª `new_policy.md` –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
2. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç `add_document.py`:
   - –ó–∞–≥—Ä—É–∑–∫–∞ –≤ S3 ‚Üí `hr/new_policy.md`
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL
   - –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥
   - –ß–∞–Ω–∫–∏–Ω–≥
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è embeddings
   - –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ Qdrant
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (indexed_at)

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~5-30 —Å–µ–∫—É–Ω–¥ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ —Ä–µ–∂–∏–º–∞ embeddings)

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–º–µ—â–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
2. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `run_ingestion.py`:
   - –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ S3 (–±–∞—Ç—á–∞–º–∏)
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏)
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   - Batch –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ Qdrant

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- Batch –∑–∞–≥—Ä—É–∑–∫–∞ –≤ S3
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ PostgreSQL –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- Batch –≥–µ–Ω–µ—Ä–∞—Ü–∏—è embeddings (–ø–æ 10 —á–∞–Ω–∫–æ–≤)
- Batch –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ Qdrant (–ø–æ 100 —Ç–æ—á–µ–∫)

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ñ–∞–π–ª `hr/existing_policy.md`
2. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç —Å —Ñ–ª–∞–≥–æ–º `--update`:
   - –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –≤ S3 (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—å)
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL (version++)
   - **–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —á–∞–Ω–∫–æ–≤ –∏–∑ Qdrant** (–ø–æ doc_id)
   - –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Å –Ω–æ–≤—ã–º–∏ —á–∞–Ω–∫–∞–º–∏
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (indexed_at, version)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (version –≤ –ë–î)
- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —á–∞–Ω–∫–æ–≤ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—á–µ—Ä–µ–∑ updated_at)

---

## üõ†Ô∏è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ `S3DocumentStorage` - –∑–∞–≥—Ä—É–∑–∫–∞ –≤ S3
- ‚úÖ `DocumentRepository` - —Ä–∞–±–æ—Ç–∞ —Å PostgreSQL
- ‚úÖ `DocumentLoader` - –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ S3/local
- ‚úÖ `Chunker` - —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —á–∞–Ω–∫–∏
- ‚úÖ `EmbeddingService` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è embeddings
- ‚úÖ `QdrantIndexer` - –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ Qdrant
- ‚úÖ `run_ingestion.py` - –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
- ‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- ‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- ‚ö†Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —á–∞–Ω–∫–æ–≤ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
- ‚ö†Ô∏è –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

---

## üìä –°—Ç–∞—Ç—É—Å—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### –í PostgreSQL

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|----------|
| `indexed_at` | `NULL` | –î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –Ω–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω |
| `indexed_at` | `2024-12-19 10:00:00` | –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω |
| `version` | `1` | –ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ |
| `version` | `2+` | –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è |

### –í Qdrant

| –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| –¢–æ—á–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç | –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω |
| –¢–æ—á–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç | –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ —É–¥–∞–ª–µ–Ω |

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ PostgreSQL

```python
from app.storage.document_repository import DocumentRepository

repo = DocumentRepository()
doc = repo.get_document_by_s3_key("hr/hr_new_policy.md")

if doc.indexed_at:
    print(f"‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω: {doc.indexed_at}")
    print(f"   Embedding mode: {doc.embedding_mode}")
    print(f"   Embedding dim: {doc.embedding_dim}")
else:
    print("‚ö†Ô∏è –î–æ–∫—É–º–µ–Ω—Ç –µ—â–µ –Ω–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω")
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Qdrant

```python
from qdrant_client import QdrantClient

client = QdrantClient("localhost", port=6333)
points = client.scroll(
    collection_name="neuro_docs",
    scroll_filter={
        "must": [{"key": "doc_id", "match": {"value": "doc_123"}}]
    }
)
print(f"–ù–∞–π–¥–µ–Ω–æ —á–∞–Ω–∫–æ–≤ –≤ Qdrant: {len(points[0])}")
```

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è production

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Ñ–∞–π–ª–∞
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (–º–∞–∫—Å–∏–º—É–º 10MB)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ (UTF-8)

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
   - Retry –¥–ª—è S3 –æ–ø–µ—Ä–∞—Ü–∏–π
   - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ PostgreSQL
   - Rollback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
   - –ú–µ—Ç—Ä–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   - –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
   - Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–µ–∑–¥–µ, –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ embeddings –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è](./storage_architecture.md)
- [–ü—Ä–æ—Ü–µ—Å—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏](./indexing_process.md)
- [–ò—Ç–æ–≥–∏ –º–∏–≥—Ä–∞—Ü–∏–∏](./migration_summary.md)
- [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è S3 –∏ PostgreSQL](./integration_summary.md)

