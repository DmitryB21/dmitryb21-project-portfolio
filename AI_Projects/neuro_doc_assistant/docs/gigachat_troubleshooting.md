# Устранение проблем с GigaChat API

## Анализ ошибок векторизации

### Ошибка 400: "Can't decode 'Authorization' header"

**Причина:** Неправильный формат `GIGACHAT_AUTH_KEY` или неверные Client ID/Secret

**Решение:**
1. Проверьте формат auth key:
   ```bash
   python scripts/check_gigachat_auth_key.py
   ```

2. Если формат неправильный, пересоздайте auth key:
   ```bash
   python scripts/setup_gigachat_auth.py
   ```

3. Убедитесь, что Client ID и Client Secret:
   - Получены из личного кабинета GigaChat
   - Не истекли
   - Имеют доступ к Embeddings API

### Ошибка 429: "Too Many Requests"

**Причина:** Превышен лимит запросов к API (rate limiting)

**Решение:**
1. Система автоматически обрабатывает rate limiting:
   - Увеличено количество retry попыток (5 вместо 3)
   - Добавлен exponential backoff (2, 4, 8 секунд)
   - Учитывается заголовок `Retry-After` от сервера
   - Добавлены задержки между батчами (0.5 сек) и запросами (0.1 сек)

2. Если ошибки продолжаются:
   - Увеличьте задержки в `scripts/run_ingestion.py` (строка ~197)
   - Уменьшите размер батча в `scripts/run_ingestion.py` (строка ~179, `batch_size = 10`)

3. Проверьте лимиты вашего аккаунта GigaChat:
   - Для GIGACHAT_API_PERS: обычно 100 запросов/минуту
   - Для GIGACHAT_API_B2B/CORP: могут быть другие лимиты

## Что произошло при индексации

По логам видно:
- ✅ **Индексация завершена успешно** (450 чанков проиндексировано)
- ⚠️ **Использованы mock embeddings** вместо реальных из-за ошибок API

### Почему использовались mock embeddings?

При ошибках API (400, 429) система автоматически переключается на mock mode для каждого запроса, который не удался. Это позволяет:
- Не прерывать процесс индексации
- Завершить индексацию даже при проблемах с API
- Использовать систему для тестирования

### Как использовать реальные embeddings?

1. **Исправьте ошибку 400:**
   - Проверьте `GIGACHAT_AUTH_KEY`: `python scripts/check_gigachat_auth_key.py`
   - Пересоздайте auth key: `python scripts/setup_gigachat_auth.py`
   - Убедитесь, что Client ID/Secret правильные

2. **Избегайте rate limiting (429):**
   - Система уже настроена с задержками
   - При необходимости увеличьте задержки между батчами
   - Уменьшите размер батча, если лимиты строгие

3. **Проверьте подключение:**
   ```bash
   python scripts/test_gigachat_connection.py
   ```

## Улучшения в коде

### 1. Обработка rate limiting (429)
- Автоматическое ожидание с учётом заголовка `Retry-After`
- Exponential backoff для retry (2, 4, 8 секунд)
- Увеличено количество попыток (5 вместо 3)

### 2. Задержки между запросами
- 0.5 секунды между батчами
- 0.1 секунды между запросами внутри батча

### 3. Улучшенное логирование
- Понятные сообщения об ошибках
- Информация о том, когда используется mock mode

## Рекомендации

1. **Для production:**
   - Используйте реальные embeddings (исправьте ошибки API)
   - Настройте мониторинг rate limiting
   - Рассмотрите использование очереди запросов для больших объёмов

2. **Для разработки:**
   - Mock mode подходит для тестирования
   - Используйте реальные embeddings для финального тестирования

3. **При больших объёмах:**
   - Уменьшите размер батча (например, `batch_size = 5`)
   - Увеличьте задержки между батчами (например, `time.sleep(1.0)`)
   - Рассмотрите асинхронную обработку

