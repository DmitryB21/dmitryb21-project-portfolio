# Вопросы по архитектуре и требованиям — Neuro_Doc_Assistant

Документ содержит вопросы, возникающие при проектировании архитектуры, для уточнения требований.

## Формат записи

Каждый вопрос содержит:
- **Номер**: Q-1, Q-2, ...
- **Формулировка**: Чёткая формулировка вопроса
- **Контекст**: Откуда возник вопрос (какой модуль, UC, тест)
- **Статус**: Открыт | Закрыт
- **Ответ**: Ответ на вопрос (заполняется при закрытии)

---

## Q-1: Формат метаданных для чанков в Qdrant

**Формулировка**: Какие поля метаданных обязательны для чанков в Qdrant? Нужны ли дополнительные поля помимо базовых (`document_id`, `category`, `file_path`, `chunk_index`)?

**Контекст**: 
- Модуль Ingestion & Indexing (QdrantIndexer)
- Необходимо определить структуру `payload` для записей в Qdrant
- Влияет на Retrieval Layer (MetadataFilter) и Agent Layer (формирование ссылок на источники)

**Статус**: Закрыт

**Ответ**: 

**Обязательные поля метаданных**:

| Поле                | Тип       | Назначение                                                  |
| ------------------- | --------- | ----------------------------------------------------------- |
| `doc_id`            | string    | Уникальный идентификатор исходного документа                |
| `chunk_id`          | string    | Уникальный идентификатор чанка                              |
| `source`            | string    | Источник документа (HR, IT, Compliance, etc.)               |
| `created_at`        | datetime  | Время индексации                                            |
| `text_length`       | int       | Длина текста в токенах или символах (для контроля чанкинга) |
| `embedding_version` | string    | Версия или конфигурация embeddings                          |
| `metadata_tags`     | list[str] | Дополнительные теги, например "policy", "onboarding", "sla" |

**Опционально**: `experiment_id` для привязки чанка к конкретному экспериментальному прогону.

---

## Q-2: Стратегия overlap между чанками

**Формулировка**: Нужен ли overlap между чанками в Chunker? Если да, какой размер overlap оптимален (например, 10% от размера чанка)?

**Контекст**:
- Модуль Ingestion & Indexing (Chunker)
- Влияет на качество retrieval (может улучшить recall, но увеличит объём данных)
- Связано с экспериментальным циклом UC-6 (оптимизация chunk_size)

**Статус**: Закрыт

**Ответ**: 

Да, overlap необходим для сохранения контекста между соседними чанками.

**Размер overlap**: 20–30% от размера чанка (например, при 300 токенах overlap ≈ 60–90 токенов).

**Реализация**: Сдвиг окна при разбиении текста.

---

## Q-3: Размерность векторов embeddings

**Формулировка**: Какая размерность векторов используется в GigaChat Embeddings API? Нужно ли это фиксировать в конфигурации?

**Контекст**:
- Модуль Ingestion & Indexing (EmbeddingService)
- Необходимо для создания коллекции в Qdrant (параметр `vector_size`)

**Статус**: Закрыт

**Ответ**: 

Обычно **1536** или **1024**, зависит от выбранной модели GigaChat Embeddings.

**Важно**: Фиксировать `embedding_dim` и версию модели для воспроизводимости экспериментов.

---

## Q-4: Именование коллекций в Qdrant

**Формулировка**: Как именовать коллекции в Qdrant? Одна коллекция для всех документов или отдельные коллекции по категориям (hr, it, compliance)?

**Контекст**:
- Модуль Ingestion & Indexing (QdrantIndexer)
- Влияет на Retrieval Layer (поиск может быть ограничен одной коллекцией или несколькими)
- Связано с UC-3 (фильтрация по метаданным)

**Статус**: Закрыт

**Ответ**: 

**Одна коллекция**: `neuro_docs`

Фильтрация по категориям (HR, IT, Compliance) осуществляется через метаданные (`source` поле), а не через отдельные коллекции.

---

## Q-5: Токенизация для определения размера чанков

**Формулировка**: Как измерять размер чанков — в токенах (какая модель токенизации?) или в символах? Нужна ли нормализация для русского языка?

**Контекст**:
- Модуль Ingestion & Indexing (Chunker)
- Требование: чанки 200–400 токенов (из architecture.md)
- Влияет на эксперименты UC-6 (оптимизация chunk_size)

**Статус**: Закрыт

**Ответ**: 

Следует использовать **тот же токенизатор, что и модель embeddings** (обычно GPT-style tokenizer).

**Обоснование**: Это гарантирует, что размер чанка в токенах соответствует реальному размеру в embedding-модели.

**Для русского текста**: GigaChat API уже оптимизирован под BPE-токенизацию, достаточно стандартного токенизатора модели.

---

## Q-6: Обработка ошибок в Ingestion pipeline

**Формулировка**: Как обрабатывать ошибки при загрузке документов (нечитаемые файлы, ошибки API embeddings, проблемы с Qdrant)? Нужен ли retry механизм?

**Контекст**:
- Модуль Ingestion & Indexing (все компоненты)
- Влияет на надёжность системы и production-ready состояние

**Статус**: Открыт

**Ответ**: _Ожидается уточнение_

---

## Q-7: Формат ссылок на источники в ответе агента

**Формулировка**: Какой формат ссылок на источники должен быть в `response.sources`? Достаточно ли `file_path` и `chunk_id`, или нужны более читаемые ссылки (например, "hr_01_политика_удалённой_работы.md, раздел 2.1")?

**Контекст**:
- Модуль Generation Layer (формирование ответа)
- Тесты UC-1 требуют наличие `response.sources`, но не определяют формат ссылок
- Влияет на UX в UI Layer (UC-8)

**Статус**: Открыт

**Ответ**: _Ожидается уточнение_

---

## Q-8: Конфигурация для экспериментов UC-6

**Формулировка**: Где хранить конфигурации экспериментов (chunk_size, K, reranking on/off)? В отдельном файле конфигурации, в переменных окружения или в базе данных?

**Контекст**:
- Модуль Metadata & Storage (ExperimentRepository)
- UC-6 требует фиксацию конфигураций и сравнение метрик
- Влияет на повторяемость экспериментов

**Статус**: Открыт

**Ответ**: _Ожидается уточнение_

