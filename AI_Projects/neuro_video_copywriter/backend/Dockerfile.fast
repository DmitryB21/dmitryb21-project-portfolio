# syntax=docker/dockerfile:1.5
# Быстрая сборка БЕЗ Whisper (для разработки)
# Используйте: docker compose -f docker-compose.yml -f docker-compose.fast.yml up

FROM python:3.11-slim as base

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=off \
    PIP_DISABLE_PIP_VERSION_CHECK=on \
    PIP_DEFAULT_TIMEOUT=600 \
    PYTHONPATH=/app

WORKDIR /app

# Установка системных зависимостей
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    ffmpeg \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Установка Poetry
RUN pip install --upgrade pip && pip install poetry \
    && poetry config virtualenvs.create false \
    && poetry config installer.max-workers 4

# Копирование быстрого pyproject.toml БЕЗ openai-whisper
COPY pyproject-fast.toml /app/pyproject.toml
COPY poetry.lock /app/poetry.lock

# Генерация нового lock файла без whisper
RUN poetry lock --no-update 2>/dev/null || poetry lock

# Установка зависимостей БЕЗ openai-whisper (экономит ~1-2 часа)
# Для локальной транскрибации используйте API транскрибацию
RUN poetry install --only main --no-interaction --no-ansi || \
    (echo "Retrying..." && sleep 30 && poetry install --only main --no-interaction --no-ansi)

# Копирование кода
COPY . /app

EXPOSE 8000

CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]

