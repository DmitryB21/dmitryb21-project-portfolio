<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro-—Ä–µ–∂–∏–º ‚Äî –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–µ–Ω—Ç–∞</title>
    <link rel="stylesheet" href="{{ url_for('send_static', path='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('send_static', path='pro-style.css') }}">
    <style>
        .event-card { background: #fff; padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); margin-bottom: 16px; }
        .event-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #111827; }
        .event-meta { color: #6b7280; font-size: 14px; margin-bottom: 12px; }
        .event-summary { color: #374151; line-height: 1.5; margin-bottom: 12px; }
        .event-stats { display: flex; gap: 16px; font-size: 14px; color: #6b7280; }
        .event-channels { margin-top: 12px; }
        .channel-tag { display: inline-block; background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 8px; margin-bottom: 4px; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        .error { text-align: center; padding: 40px; color: #dc2626; }
        .filters { background: #fff; padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .filter-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
        .filter-row:last-child { margin-bottom: 0; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #2563eb; color: #fff; }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .input { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .select { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background: #fff; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ —Ç–µ–º–∞–º" */
        .topic-view-mode { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .topic-tabs { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .topic-tab { padding: 8px 16px; border: 2px solid #e5e7eb; border-radius: 8px; background: #fff; cursor: pointer; transition: all 0.2s; font-size: 14px; white-space: nowrap; }
        .topic-tab:hover { border-color: #2563eb; background: #f0f7ff; }
        .topic-tab.active { border-color: #2563eb; background: #2563eb; color: #fff; font-weight: 600; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; }
        .checkbox-wrapper input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-wrapper label { cursor: pointer; user-select: none; }
    </style>
</head>
<body>
    <div class="pro-container">
        <nav class="pro-nav">
            <div class="nav-brand">
                <h1>üì∞ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–µ–Ω—Ç–∞</h1>
                <span class="nav-subtitle">–°–æ–±—ã—Ç–∏—è –ø–æ –≤–∞—à–∏–º –∏–Ω—Ç–µ—Ä–µ—Å–∞–º</span>
            </div>
            <div class="nav-links">
                <a href="/pro/" class="nav-link">üìä –î–∞—à–±–æ—Ä–¥</a>
                <a href="/pro/feed" class="nav-link active">üì∞ –õ–µ–Ω—Ç–∞</a>
                <a href="/pro/search" class="nav-link">üîç –ü–æ–∏—Å–∫</a>
                <a href="/pro/trends" class="nav-link">üìà –¢—Ä–µ–Ω–¥—ã</a>
                <a href="/pro/onboarding" class="nav-link">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                <a href="/" class="nav-link back-link">‚Üê –ù–∞–∑–∞–¥</a>
            </div>
        </nav>

        <main class="pro-main">
            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div class="filters">
                <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
                <div class="filter-row">
                    <label>–ü–µ—Ä–∏–æ–¥:</label>
                    <select id="date-filter" class="select">
                        <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
                        <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                        <option value="week">–ù–µ–¥–µ–ª—è</option>
                        <option value="month">–ú–µ—Å—è—Ü</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadFeed()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>

            <!-- –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ —Ç–µ–º–∞–º -->
            <div class="filters">
                <div class="topic-view-mode">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="show-by-topics" onchange="toggleTopicViewMode()">
                        <label for="show-by-topics">üìã –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ —Ç–µ–º–∞–º</label>
                    </div>
                    <div id="topic-tabs-container" class="topic-tabs" style="display: none;">
                        <!-- –¢–∞–±—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π -->
            <div id="events-container">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>
            </div>
        </main>
    </div>

    <script>
        let allTopics = [];
        let currentFilters = {};
        let activeTopicTab = null;
        let topicViewMode = false;

        async function loadTopics() {
            try {
                const res = await fetch('/pro/api/topics');
                const data = await res.json();
                allTopics = data.topics || [];
                
                // –°—Ç—Ä–æ–∏–º —Ç–∞–±—ã –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ —Ç–µ–º–∞–º"
                buildTopicTabs();
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º:', e);
            }
        }
        
        function buildTopicTabs() {
            const container = document.getElementById('topic-tabs-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–± "–í—Å–µ —Ç–µ–º—ã"
            const allTab = document.createElement('div');
            allTab.className = 'topic-tab active';
            allTab.textContent = 'üì∞ –í—Å–µ —Ç–µ–º—ã';
            allTab.onclick = () => selectTopicTab(null, allTab);
            container.appendChild(allTab);
            activeTopicTab = allTab;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã
            allTopics.forEach(topic => {
                const tab = document.createElement('div');
                tab.className = 'topic-tab';
                tab.textContent = topic.name;
                tab.dataset.topicId = topic.id;
                tab.onclick = () => selectTopicTab(topic.id, tab);
                container.appendChild(tab);
            });
        }
        
        function selectTopicTab(topicId, tabElement) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö —Ç–∞–±–æ–≤
            document.querySelectorAll('.topic-tab').forEach(t => t.classList.remove('active'));
            
            // –î–µ–ª–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–± –∞–∫—Ç–∏–≤–Ω—ã–º
            tabElement.classList.add('active');
            activeTopicTab = tabElement;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º feed —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–µ–º–æ–π
            currentFilters.topic_id = topicId;
            loadFeed();
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function initTopicViewMode() {
            const checkbox = document.getElementById('show-by-topics');
            if (checkbox && checkbox.checked) {
                toggleTopicViewMode();
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ cluster_id –≤ URL
            const urlParams = new URLSearchParams(window.location.search);
            const clusterId = urlParams.get('cluster_id');
            if (clusterId) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞
                loadClusterMessages(clusterId);
            }
        }
        
        async function loadClusterMessages(clusterId) {
            try {
                const container = document.getElementById('events-container');
                container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ–±—ã—Ç–∏—è...</div>';
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è (–≤–∫–ª—é—á–∞—è —Å–æ–æ–±—â–µ–Ω–∏—è)
                const eventRes = await fetch(`/pro/api/events/${clusterId}`);
                const eventData = await eventRes.json();
                
                if (!eventData.event) {
                    container.innerHTML = '<div class="error">–°–æ–±—ã—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    return;
                }
                
                const event = eventData.event;
                
                container.innerHTML = '';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ–±—ã—Ç–∏—è
                const eventHeader = document.createElement('div');
                eventHeader.className = 'event-card';
                eventHeader.style.marginBottom = '20px';
                eventHeader.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                eventHeader.style.color = 'white';
                eventHeader.innerHTML = `
                    <div class="event-title" style="color: white; font-size: 24px; margin-bottom: 12px;">
                        ${event.title || '–°–æ–±—ã—Ç–∏–µ –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}
                    </div>
                    <div class="event-meta" style="color: rgba(255,255,255,0.9); margin-bottom: 8px;">
                        ${event.messages?.length || 0} —Å–æ–æ–±—â–µ–Ω–∏–π
                    </div>
                    ${event.summary ? `<div class="event-summary" style="color: rgba(255,255,255,0.95);">${event.summary}</div>` : ''}
                `;
                container.appendChild(eventHeader);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                if (event.messages && event.messages.length > 0) {
                    event.messages.forEach((msg, index) => {
                        const messageCard = document.createElement('div');
                        messageCard.className = 'event-card';
                        
                        const date = msg.date ? new Date(msg.date).toLocaleString('ru-RU') : 
                                    (msg.published_at ? new Date(msg.published_at).toLocaleString('ru-RU') : '–î–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞');
                        
                        messageCard.innerHTML = `
                            <div class="event-title">üì® –°–æ–æ–±—â–µ–Ω–∏–µ ${index + 1}${msg.is_primary ? ' (–æ—Å–Ω–æ–≤–Ω–æ–µ)' : ''}</div>
                            <div class="event-meta">${date} ‚Ä¢ –ö–∞–Ω–∞–ª: ${msg.channel_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</div>
                            <div class="event-summary">${msg.text || ''}</div>
                        `;
                        container.appendChild(messageCard);
                    });
                } else {
                    container.innerHTML += '<div class="error">–°–æ–±—ã—Ç–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∞—Å—Ç–µ—Ä–∞:', error);
                document.getElementById('events-container').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ–±—ã—Ç–∏—è</div>';
            }
        }
        
        function toggleTopicViewMode() {
            const checkbox = document.getElementById('show-by-topics');
            const tabsContainer = document.getElementById('topic-tabs-container');
            const filtersSection = document.querySelector('.filters:first-of-type'); // –ü–µ—Ä–≤–∞—è —Å–µ–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
            
            topicViewMode = checkbox.checked;
            
            if (topicViewMode) {
                tabsContainer.style.display = 'flex';
                if (filtersSection) filtersSection.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            } else {
                tabsContainer.style.display = 'none';
                if (filtersSection) filtersSection.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                currentFilters = {};
                loadFeed();
            }
        }

        async function loadFeed() {
            try {
                const container = document.getElementById('events-container');
                container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>';

                // –ï—Å–ª–∏ —Ä–µ–∂–∏–º "–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ —Ç–µ–º–∞–º" –≤–∫–ª—é—á–µ–Ω –∏ –≤—ã–±—Ä–∞–Ω–∞ —Ç–µ–º–∞ (–Ω–µ "–í—Å–µ —Ç–µ–º—ã")
                if (topicViewMode && currentFilters.topic_id !== undefined && currentFilters.topic_id !== null) {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–µ–º–µ
                    const res = await fetch(`/pro/api/messages/by-topic?topic_id=${currentFilters.topic_id}&limit=50`);
                    const data = await res.json();
                    
                    if (data.messages && data.messages.length > 0) {
                        container.innerHTML = '';
                        data.messages.forEach(msg => {
                            const messageCard = document.createElement('div');
                            messageCard.className = 'event-card';
                            
                            const date = msg.published_at ? new Date(msg.published_at).toLocaleString('ru-RU') : '–î–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞';
                            
                            messageCard.innerHTML = `
                                <div class="event-title">üì® –°–æ–æ–±—â–µ–Ω–∏–µ #${msg.message_id}</div>
                                <div class="event-meta">${date} ‚Ä¢ –ö–∞–Ω–∞–ª: ${msg.channel_name} ‚Ä¢ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(msg.score * 100).toFixed(1)}%</div>
                                <div class="event-summary">${msg.text}</div>
                            `;
                            container.appendChild(messageCard);
                        });
                    } else {
                        container.innerHTML = '<div class="error">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ.</div>';
                    }
                    return;
                }
                
                // –ï—Å–ª–∏ —Ä–µ–∂–∏–º "–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ —Ç–µ–º–∞–º" –≤–∫–ª—é—á–µ–Ω, –Ω–æ –≤—ã–±—Ä–∞–Ω–∞ "–í—Å–µ —Ç–µ–º—ã" –∏–ª–∏ —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã

                // –û–±—ã—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π (–∫–ª–∞—Å—Ç–µ—Ä–æ–≤)
                const filters = {};
                const dateFilter = document.getElementById('date-filter').value;

                if (dateFilter) {
                    const now = new Date();
                    if (dateFilter === 'today') {
                        filters.date_from = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
                    } else if (dateFilter === 'week') {
                        filters.date_from = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString();
                    } else if (dateFilter === 'month') {
                        filters.date_from = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString();
                    }
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è
                const params = new URLSearchParams({
                    user_id: 'default_user',
                    limit: '20',
                    offset: '0',
                    ...filters
                });

                const res = await fetch(`/pro/api/feed?${params}`);
                const data = await res.json();

                if (data.events && data.events.length > 0) {
                    container.innerHTML = '';
                    data.events.forEach(event => {
                        const eventCard = document.createElement('div');
                        eventCard.className = 'event-card';
                        
                        const channelNames = event.channel_names || [];
                        const channelTags = channelNames.map(name => `<span class="channel-tag">${name}</span>`).join('');
                        
                        eventCard.innerHTML = `
                            <div class="event-title">${event.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                            <div class="event-meta">
                                ${new Date(event.created_at).toLocaleString('ru-RU')} ‚Ä¢ 
                                ${event.message_count || 0} —Å–æ–æ–±—â–µ–Ω–∏–π ‚Ä¢ 
                                ${channelNames.length} –∫–∞–Ω–∞–ª–æ–≤
                            </div>
                            <div class="event-summary">${event.summary || ''}</div>
                            <div class="event-stats">
                                <span>üìä –°–æ–æ–±—â–µ–Ω–∏–π: ${event.message_count || 0}</span>
                                <span>üì∫ –ö–∞–Ω–∞–ª–æ–≤: ${channelNames.length}</span>
                            </div>
                            ${channelTags ? `<div class="event-channels">${channelTags}</div>` : ''}
                        `;
                        container.appendChild(eventCard);
                    });
                } else {
                    container.innerHTML = '<div class="error">–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—ã –≤ —Ä–∞–∑–¥–µ–ª–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏".</div>';
                }

            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–µ–Ω—Ç—ã:', e);
                document.getElementById('events-container').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π</div>';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadTopics().then(() => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ cluster_id –≤ URL
                const urlParams = new URLSearchParams(window.location.search);
                const clusterId = urlParams.get('cluster_id');
                if (clusterId) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞
                    loadClusterMessages(clusterId);
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é –ª–µ–Ω—Ç—É
                    loadFeed();
                }
                initTopicViewMode();
            });
        });
    </script>
</body>
</html>
