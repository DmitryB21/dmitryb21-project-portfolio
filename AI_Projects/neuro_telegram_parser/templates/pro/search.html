<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ - Pro-—Ä–µ–∂–∏–º</title>
    <link rel="stylesheet" href="{{ url_for('send_static', path='style.css') }}?v=2.2">
    <link rel="stylesheet" href="{{ url_for('send_static', path='pro-style.css') }}?v=2.2">
    <style>
        .search-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .search-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .search-form {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .search-input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .search-btn {
            padding: 15px 30px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .search-btn:hover {
            background: #0056b3;
        }
        
        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .search-results {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .result-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .result-score {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .result-text {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .result-meta {
            display: flex;
            gap: 20px;
            font-size: 12px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        .saved-searches {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .saved-search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .saved-search-info {
            flex: 1;
        }
        
        .saved-search-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .saved-search-query {
            font-size: 12px;
            color: #666;
        }
        
        .saved-search-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="pro-container">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è Pro-—Ä–µ–∂–∏–º–∞ -->
        <nav class="pro-nav">
            <div class="nav-brand">
                <h1>üöÄ Pro-—Ä–µ–∂–∏–º</h1>
                <span class="nav-subtitle">–ù–µ–π—Ä–æ-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π</span>
            </div>
            <div class="nav-links">
                <a href="/pro/" class="nav-link">üìä –î–∞—à–±–æ—Ä–¥</a>
                <a href="/pro/feed" class="nav-link">üì∞ –õ–µ–Ω—Ç–∞</a>
                <a href="/pro/search" class="nav-link active">üîç –ü–æ–∏—Å–∫</a>
                <a href="/pro/trends" class="nav-link">üìà –¢—Ä–µ–Ω–¥—ã</a>
                <a href="/pro/onboarding" class="nav-link">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                <a href="/" class="nav-link back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É</a>
            </div>
        </nav>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="pro-main">
            <div class="search-container">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                <div class="search-header">
                    <h2>üîç –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫</h2>
                    <p>–ù–∞–π–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —Å–º—ã—Å–ª—É, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º</p>
                </div>

                <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
                <div class="search-form">
                    <div class="search-input-group">
                        <input type="text" id="search-query" class="search-input" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å..." 
                               value="">
                        <button class="search-btn" onclick="performSearch()">
                            üîç –ù–∞–π—Ç–∏
                        </button>
                    </div>
                    
                    <div class="search-filters">
                        <div class="filter-group">
                            <label for="topic-filter">–¢–µ–º–∞:</label>
                            <select id="topic-filter">
                                <option value="">–í—Å–µ —Ç–µ–º—ã</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="channel-filter">–ö–∞–Ω–∞–ª:</label>
                            <select id="channel-filter">
                                <option value="">–í—Å–µ –∫–∞–Ω–∞–ª—ã</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="date-from">–° –¥–∞—Ç—ã:</label>
                            <input type="date" id="date-from">
                        </div>
                        
                        <div class="filter-group">
                            <label for="date-to">–ü–æ –¥–∞—Ç—É:</label>
                            <input type="date" id="date-to">
                        </div>
                        
                        <div class="filter-group">
                            <label for="limit">–õ–∏–º–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:</label>
                            <select id="limit">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn-sm btn-primary" onclick="saveSearch()">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫
                        </button>
                        <button class="btn-sm btn-primary" onclick="clearFilters()">
                            üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                        </button>
                    </div>
                </div>

                <!-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏ -->
                <div class="saved-searches" id="saved-searches-section" style="display: none;">
                    <h3>üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏</h3>
                    <div id="saved-searches-list">
                        <!-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                    </div>
                </div>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
                <div class="search-results">
                    <h3>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h3>
                    <div id="search-results">
                        <div class="empty">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        document.addEventListener('DOMContentLoaded', function() {
            loadFilters();
            loadSavedSearches();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ç–µ–º—ã –∏ –∫–∞–Ω–∞–ª—ã)
        async function loadFilters() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–º—ã
                const topicsResponse = await fetch('/pro/api/topics');
                const topicsData = await topicsResponse.json();
                
                if (topicsData.topics && topicsData.topics.length > 0) {
                    const topicSelect = document.getElementById('topic-filter');
                    topicsData.topics.forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic.id;
                        option.textContent = topic.name;
                        topicSelect.appendChild(option);
                    });
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–Ω–∞–ª—ã
                const channelsResponse = await fetch('/pro/api/channels');
                const channelsData = await channelsResponse.json();
                
                if (channelsData.channels && channelsData.channels.length > 0) {
                    const channelSelect = document.getElementById('channel-filter');
                    channelsData.channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.id;
                        option.textContent = channel.title || channel.username || `Channel ${channel.id}`;
                        channelSelect.appendChild(option);
                    });
                }
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', e);
            }
        }

        // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
        async function performSearch() {
            const query = document.getElementById('search-query').value.trim();
            if (!query) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }

            const filters = getFilters();
            const limit = parseInt(document.getElementById('limit').value);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('search-results').innerHTML = '<div class="loading">üîç –ü–æ–∏—Å–∫...</div>';

            try {
                const response = await fetch('/pro/api/search/semantic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        filters: filters,
                        limit: limit
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.results) {
                    displaySearchResults(data.results, query);
                } else {
                    document.getElementById('search-results').innerHTML = 
                        `<div class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
                }
                
            } catch (e) {
                document.getElementById('search-results').innerHTML = 
                    '<div class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</div>';
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function getFilters() {
            const filters = {};
            
            const topicId = document.getElementById('topic-filter').value;
            if (topicId) filters.topic_id = parseInt(topicId);
            
            const channelId = document.getElementById('channel-filter').value;
            if (channelId) filters.channel_id = parseInt(channelId);
            
            const dateFrom = document.getElementById('date-from').value;
            if (dateFrom) filters.date_from = dateFrom;
            
            const dateTo = document.getElementById('date-to').value;
            if (dateTo) filters.date_to = dateTo;
            
            return filters;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
        function displaySearchResults(results, query) {
            const container = document.getElementById('search-results');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="empty">–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }

            const html = results.map(result => `
                <div class="result-item">
                    <div class="result-header">
                        <strong>üìù –°–æ–æ–±—â–µ–Ω–∏–µ #${result.message_id}</strong>
                        <span class="result-score">${(result.score * 100).toFixed(1)}%</span>
                    </div>
                    <div class="result-text">${result.text}</div>
                    <div class="result-meta">
                        <span>üì∫ ${result.channel_name}</span>
                        <span>üìÖ ${new Date(result.published_at).toLocaleString()}</span>
                        <span>üëÅÔ∏è ${result.views_count || 0} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</span>
                        <span>üîÑ ${result.forwards_count || 0} –ø–µ—Ä–µ—Å—ã–ª–æ–∫</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function clearFilters() {
            document.getElementById('search-query').value = '';
            document.getElementById('topic-filter').value = '';
            document.getElementById('channel-filter').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            document.getElementById('limit').value = '20';
            
            document.getElementById('search-results').innerHTML = 
                '<div class="empty">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞</div>';
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
        async function saveSearch() {
            const query = document.getElementById('search-query').value.trim();
            if (!query) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                return;
            }

            const name = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞:');
            if (!name) return;

            const filters = getFilters();
            const cadence = prompt('–ß–∞—Å—Ç–æ—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (daily/weekly/monthly):') || 'daily';

            try {
                const response = await fetch('/pro/api/search/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        query: query,
                        filters: filters,
                        cadence: cadence
                    })
                });

                const data = await response.json();
                
                if (data.status === 'ok') {
                    alert('‚úÖ –ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                    loadSavedSearches();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
                
            } catch (e) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤
        async function loadSavedSearches() {
            try {
                const response = await fetch('/pro/api/search/saved');
                const data = await response.json();
                
                if (data.status === 'ok' && data.searches.length > 0) {
                    document.getElementById('saved-searches-section').style.display = 'block';
                    
                    const html = data.searches.map(search => `
                        <div class="saved-search-item">
                            <div class="saved-search-info">
                                <div class="saved-search-name">${search.name}</div>
                                <div class="saved-search-query">"${search.query}"</div>
                            </div>
                            <div class="saved-search-actions">
                                <button class="btn-sm btn-primary" onclick="loadSavedSearch(${search.id})">
                                    üîç –í—ã–ø–æ–ª–Ω–∏—Ç—å
                                </button>
                                <button class="btn-sm btn-danger" onclick="deleteSavedSearch(${search.id})">
                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('saved-searches-list').innerHTML = html;
                } else {
                    document.getElementById('saved-searches-section').style.display = 'none';
                }
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤:', e);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
        async function loadSavedSearch(searchId) {
            try {
                const response = await fetch(`/pro/api/search/saved/${searchId}`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    const search = data.search;
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('search-query').value = search.query;
                    if (search.filters.topic_id) {
                        document.getElementById('topic-filter').value = search.filters.topic_id;
                    }
                    if (search.filters.channel_id) {
                        document.getElementById('channel-filter').value = search.filters.channel_id;
                    }
                    if (search.filters.date_from) {
                        document.getElementById('date-from').value = search.filters.date_from;
                    }
                    if (search.filters.date_to) {
                        document.getElementById('date-to').value = search.filters.date_to;
                    }
                    
                    // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
                    performSearch();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∏—Å–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
                
            } catch (e) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
        async function deleteSavedSearch(searchId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫?')) return;

            try {
                const response = await fetch(`/pro/api/search/saved/${searchId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.status === 'ok') {
                    alert('‚úÖ –ü–æ–∏—Å–∫ —É–¥–∞–ª–µ–Ω!');
                    loadSavedSearches();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
                
            } catch (e) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }

        // –ü–æ–∏—Å–∫ –ø–æ Enter
        document.getElementById('search-query').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    </script>
</body>
</html>
