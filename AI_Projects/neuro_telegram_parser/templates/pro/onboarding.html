<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro-—Ä–µ–∂–∏–º ‚Äî –û–Ω–±–æ—Ä–¥–∏–Ω–≥</title>
    <link rel="stylesheet" href="{{ url_for('send_static', path='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('send_static', path='pro-style.css') }}">
    <style>
        .chips { display: flex; flex-wrap: wrap; gap: 10px; }
        .chip { padding: 8px 12px; border-radius: 16px; background: #f0f2f5; cursor: pointer; user-select: none; border: 1px solid #e5e7eb; }
        .chip.selected { outline: 2px solid #2563eb; background: #e0e7ff; }
        .section { background: #fff; padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); margin-bottom: 16px; }
        .section h3 { margin: 0 0 12px 0; }
        .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .save-btn { padding: 10px 16px; background: #2563eb; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
        .save-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .small { color: #6b7280; font-size: 12px; }
        .input { padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 8px; }
        .list { display: grid; gap: 8px; }
        .card { padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fafafa; }
    </style>
    </head>
<body>
    <div class="pro-container">
        <nav class="pro-nav">
            <div class="nav-brand">
                <h1>‚öôÔ∏è –û–Ω–±–æ—Ä–¥–∏–Ω–≥</h1>
                <span class="nav-subtitle">–í—ã–±–æ—Ä –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –∏ —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã</span>
            </div>
            <div class="nav-links">
                <a href="/pro/" class="nav-link">üìä –î–∞—à–±–æ—Ä–¥</a>
                <a href="/pro/onboarding" class="nav-link active">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                <a href="/pro/feed" class="nav-link">üì∞ –õ–µ–Ω—Ç–∞</a>
                <a href="/pro/search" class="nav-link">üîç –ü–æ–∏—Å–∫</a>
                <a href="/pro/trends" class="nav-link">üìà –¢—Ä–µ–Ω–¥—ã</a>
                <a href="/" class="nav-link back-link">‚Üê –ù–∞–∑–∞–¥</a>
            </div>
        </nav>

        <main class="pro-main">
            <div class="section">
                <h3>1) –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—ã</h3>
                <div id="topics" class="chips"><div class="small">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º...</div></div>
                <div class="small" id="topics-selected">–í—ã–±—Ä–∞–Ω–æ: 0</div>
            </div>

            <div class="section">
                <h3>2) –î–æ–±–∞–≤—å—Ç–µ —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</h3>
                <div class="row">
                    <input id="channel-input" class="input" placeholder="username –∏–ª–∏ ID" />
                    <button class="save-btn" onclick="addSeedChannel()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div id="seed-list" class="list" style="margin-top:10px"></div>
                <div class="small">–°–æ–≤–µ—Ç: –¥–æ–±–∞–≤—å—Ç–µ 3‚Äì5 –≤–∞—à–∏—Ö –ª—é–±–∏–º—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏</div>
            </div>

            <div class="section">
                <h3>3) –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</h3>
                <button id="save-btn" class="save-btn" onclick="savePreferences()" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</button>
                <span class="small" id="save-status"></span>
            </div>

            <div class="section">
                <h3>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–æ–≤</h3>
                <div id="reco-list" class="list"><div class="small">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.</div></div>
            </div>
        </main>
    </div>

    <script>
        let allTopics = [];
        let selectedTopics = [];
        let seedChannels = [];

        function renderTopics() {
            const wrap = document.getElementById('topics');
            wrap.innerHTML = '';
            allTopics.forEach(t => {
                const el = document.createElement('div');
                el.className = 'chip' + (selectedTopics.includes(t.id) ? ' selected' : '');
                el.style.borderColor = t.color || '#e5e7eb';
                el.style.color = '#111827';
                el.textContent = t.name;
                el.onclick = () => {
                    const idx = selectedTopics.indexOf(t.id);
                    if (idx === -1) selectedTopics.push(t.id); else selectedTopics.splice(idx, 1);
                    renderTopics();
                    updateSelectedCount();
                    updateSaveEnabled();
                };
                wrap.appendChild(el);
            });
        }

        function updateSelectedCount() {
            document.getElementById('topics-selected').textContent = `–í—ã–±—Ä–∞–Ω–æ: ${selectedTopics.length}`;
        }

        function updateSaveEnabled() {
            document.getElementById('save-btn').disabled = selectedTopics.length === 0 && seedChannels.length === 0;
        }

        function renderSeeds() {
            const list = document.getElementById('seed-list');
            list.innerHTML = '';
            if (seedChannels.length === 0) {
                list.innerHTML = '<div class="small">–ö–∞–Ω–∞–ª—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';
                return;
            }
            seedChannels.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.textContent = c;
                div.onclick = () => { seedChannels.splice(i,1); renderSeeds(); updateSaveEnabled(); };
                list.appendChild(div);
            });
        }

        function addSeedChannel() {
            const val = document.getElementById('channel-input').value.trim();
            if (!val) return;
            if (!seedChannels.includes(val)) seedChannels.push(val);
            document.getElementById('channel-input').value = '';
            renderSeeds();
            updateSaveEnabled();
        }

        async function savePreferences() {
            try {
                const res = await fetch('/pro/api/onboarding/preferences', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: 'default_user', selected_topics: selectedTopics, seed_channels: seedChannels })
                });
                const data = await res.json();
                document.getElementById('save-status').textContent = data.status === 'success' ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ' : (data.error || '–û—à–∏–±–∫–∞');
                if (data.status === 'success') {
                    loadRecommendations();
                }
            } catch (e) {
                document.getElementById('save-status').textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
            }
        }

        async function loadTopics() {
            try {
                const res = await fetch('/pro/api/topics');
                const data = await res.json();
                allTopics = data.topics || [];
                renderTopics();
            } catch (e) {
                document.getElementById('topics').innerHTML = '<div class="small">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º</div>';
            }
        }

        async function loadRecommendations() {
            try {
                const res = await fetch('/pro/api/onboarding/recommendations?user_id=default_user&limit=10');
                const data = await res.json();
                const list = document.getElementById('reco-list');
                list.innerHTML = '';
                if (!data.recommendations || data.recommendations.length === 0) {
                    list.innerHTML = '<div class="small">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>';
                    return;
                }
                data.recommendations.forEach(r => {
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `<b>${r.name || r.username || r.id}</b> ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–π: ${r.message_count ?? '-'}, score: ${r.avg_topic_score ?? '-'}`;
                    list.appendChild(div);
                });
            } catch (e) {
                document.getElementById('reco-list').innerHTML = '<div class="small">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadTopics();
            renderSeeds();
            updateSelectedCount();
            updateSaveEnabled();
        });
    </script>
</body>
</html>


