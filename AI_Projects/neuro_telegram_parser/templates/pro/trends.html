<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ - Pro —Ä–µ–∂–∏–º</title>
    <link rel="stylesheet" href="/static/style.css?v=2.0">
    <link rel="stylesheet" href="/static/pro-style.css?v=2.0">
    <style>
        .trends-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .period-btn {
            padding: 8px 16px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .period-btn.active {
            background: #007bff;
            color: white;
        }
        
        .period-btn:hover {
            background: #0056b3;
            color: white;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .analytics-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .analytics-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .analytics-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        
        .analytics-card .subtitle {
            color: #666;
            font-size: 12px;
        }
        
        .trends-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .trend-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
        }
        
        .trend-item:hover {
            background-color: #f8f9fa;
        }
        
        .trend-item:last-child {
            border-bottom: none;
        }
        
        .trend-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .trend-rank.top-3 {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
        }
        
        .trend-info {
            flex: 1;
        }
        
        .trend-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .trend-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .trend-metrics {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }
        
        .trend-metric {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .trend-metric .icon {
            font-size: 14px;
        }
        
        .trend-growth {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }
        
        .trend-growth.positive {
            color: #28a745;
        }
        
        .trend-growth.negative {
            color: #dc3545;
        }
        
        .trend-growth.stable {
            color: #6c757d;
        }
        
        .trend-actions {
            display: flex;
            gap: 10px;
        }
        
        .trend-btn {
            padding: 6px 12px;
            border: 1px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .trend-btn:hover {
            background: #007bff;
            color: white;
        }
        
        .connections-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .connections-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .connections-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .connection-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .connection-item:last-child {
            border-bottom: none;
        }
        
        .connection-strength {
            width: 60px;
            text-align: center;
            font-weight: bold;
            color: #007bff;
        }
        
        .connection-name {
            flex: 1;
            margin-left: 10px;
        }
        
        .connection-metrics {
            font-size: 12px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="trends-container">
        <nav class="pro-nav">
            <div class="nav-brand">
                <h2>üöÄ Pro —Ä–µ–∂–∏–º</h2>
            </div>
            <div class="nav-links">
                <a href="/pro/" class="nav-link">üìä –î–∞—à–±–æ—Ä–¥</a>
                <a href="/pro/feed" class="nav-link">üì∞ –õ–µ–Ω—Ç–∞</a>
                <a href="/pro/search" class="nav-link">üîç –ü–æ–∏—Å–∫</a>
                <a href="/pro/trends" class="nav-link active">üìà –¢—Ä–µ–Ω–¥—ã</a>
                <a href="/pro/onboarding" class="nav-link">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                <a href="/" class="nav-link back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É</a>
            </div>
        </nav>

        <div class="period-selector">
            <button class="period-btn active" data-period="daily">üìÖ –ó–∞ –¥–µ–Ω—å</button>
            <button class="period-btn" data-period="weekly">üìÜ –ó–∞ –Ω–µ–¥–µ–ª—é</button>
            <button class="period-btn" data-period="monthly">üìä –ó–∞ –º–µ—Å—è—Ü</button>
        </div>

        <div class="analytics-grid" id="analytics-grid">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...</div>
        </div>

        <div class="trends-section">
            <h3>üî• –¢–æ–ø —Å–æ–±—ã—Ç–∏—è</h3>
            <div id="trends-list">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–≤—è–∑–µ–π —Ç–µ–º -->
    <div class="connections-modal" id="connections-modal">
        <div class="connections-content">
            <div class="connections-header">
                <h3 id="connections-title">–°–≤—è–∑–∏ —Ç–µ–º—ã</h3>
                <button class="close-btn" onclick="closeConnectionsModal()">&times;</button>
            </div>
            <div id="connections-list">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–µ–π...</div>
            </div>
        </div>
    </div>

    <script>
        let currentPeriod = 'daily';
        let currentTopicId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadTrendsData();
            setupPeriodSelector();
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞
        function setupPeriodSelector() {
            const periodBtns = document.querySelectorAll('.period-btn');
            periodBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                    periodBtns.forEach(b => b.classList.remove('active'));
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ
                    this.classList.add('active');
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–∏–æ–¥
                    currentPeriod = this.dataset.period;
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    loadTrendsData();
                });
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤
        async function loadTrendsData() {
            try {
                await Promise.all([
                    loadAnalytics(),
                    loadTrends()
                ]);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        async function loadAnalytics() {
            try {
                const response = await fetch(`/pro/api/trends/analytics?period=${currentPeriod}`);
                const data = await response.json();

                if (data.analytics) {
                    const analytics = data.analytics;
                    const analyticsGrid = document.getElementById('analytics-grid');
                    
                    analyticsGrid.innerHTML = `
                        <div class="analytics-card">
                            <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è</h3>
                            <div class="value">${analytics.total_active_events || 0}</div>
                            <div class="subtitle">–∑–∞ ${getPeriodText(currentPeriod)}</div>
                        </div>
                        <div class="analytics-card">
                            <h3>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                            <div class="value">${analytics.total_messages || 0}</div>
                            <div class="subtitle">–ø–æ —Å–æ–±—ã—Ç–∏—è–º</div>
                        </div>
                        <div class="analytics-card">
                            <div class="subtitle">–∫–∞—á–µ—Å—Ç–≤–æ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏</div>
                        </div>
                        <div class="analytics-card">
                            <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã</h3>
                            <div class="value">${analytics.total_active_channels || 0}</div>
                            <div class="subtitle">–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</div>
                        </div>
                        <div class="analytics-card">
                            <h3>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</h3>
                            <div class="value">${formatNumber(analytics.total_views || 0)}</div>
                            <div class="subtitle">–æ–±—â–∏–π –æ—Ö–≤–∞—Ç</div>
                        </div>
                        <div class="analytics-card">
                            <h3>–ü–µ—Ä–µ—Å—ã–ª–∫–∏</h3>
                            <div class="value">${formatNumber(analytics.total_forwards || 0)}</div>
                            <div class="subtitle">–≤–∏—Ä—É—Å–Ω–æ—Å—Ç—å</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
                document.getElementById('analytics-grid').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</div>';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–Ω–¥–æ–≤
        async function loadTrends() {
            try {
                const response = await fetch(`/pro/api/trends?period=${currentPeriod}&limit=20`);
                const data = await response.json();

                if (data.trends) {
                    const trendsList = document.getElementById('trends-list');
                    trendsList.innerHTML = '';

                    data.trends.forEach((trend, index) => {
                        const trendItem = document.createElement('div');
                        trendItem.className = 'trend-item';
                        
                        const rankClass = index < 3 ? 'top-3' : '';
                        
                        const eventTitle = trend.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                        const eventSummary = trend.summary ? (trend.summary.length > 100 ? trend.summary.substring(0, 100) + '...' : trend.summary) : '';
                        const topicName = trend.topic_name || '–ë–µ–∑ —Ç–µ–º—ã';
                        const topicColor = trend.topic_color || '#808080';
                        
                        trendItem.innerHTML = `
                            <div class="trend-rank ${rankClass}">${index + 1}</div>
                            <div class="trend-info">
                                <div class="trend-name" style="color: ${topicColor}">${escapeHtml(eventTitle)}</div>
                                ${eventSummary ? `<div class="trend-description">${escapeHtml(eventSummary)}</div>` : ''}
                                <div style="font-size: 11px; color: #999; margin-bottom: 5px;">
                                    <span style="color: ${topicColor}">üìÅ ${topicName}</span>
                                </div>
                                <div class="trend-metrics">
                                    <div class="trend-metric">
                                        <span class="icon">üí¨</span>
                                        <span>${trend.message_count || 0} —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                                    </div>
                                    <div class="trend-metric">
                                        <span class="icon">üì∫</span>
                                        <span>${trend.channel_count || 0} –∫–∞–Ω–∞–ª–æ–≤</span>
                                    </div>
                                    <div class="trend-metric">
                                        <span class="icon">üëÅÔ∏è</span>
                                        <span>${formatNumber(trend.total_views || 0)} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</span>
                                    </div>
                                </div>
                            </div>
                            <div class="trend-growth ${trend.trend_direction}">
                                <span class="icon">${trend.trend_icon}</span>
                                <span>${trend.growth_percentage > 0 ? '+' : ''}${trend.growth_percentage}%</span>
                            </div>
                            <div class="trend-actions">
                                <button class="trend-btn" onclick="showEventChannels('${trend.cluster_id}', '${escapeHtml(eventTitle)}')">
                                    üì∫ –ö–∞–Ω–∞–ª—ã
                                </button>
                                <button class="trend-btn" onclick="window.location.href='/pro/feed?cluster_id=${trend.cluster_id}'">
                                    üîó –î–µ—Ç–∞–ª–∏
                                </button>
                            </div>
                        `;
                        
                        trendsList.appendChild(trendItem);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤:', error);
                document.getElementById('trends-list').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤</div>';
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤—è–∑–∏ —Ç–µ–º—ã
        async function showTopicConnections(topicId, topicName) {
            currentTopicId = topicId;
            const modal = document.getElementById('connections-modal');
            const title = document.getElementById('connections-title');
            const list = document.getElementById('connections-list');
            
            title.textContent = `–°–≤—è–∑–∏ —Ç–µ–º—ã "${topicName}"`;
            modal.style.display = 'block';
            list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–µ–π...</div>';
            
            try {
                const response = await fetch(`/pro/api/trends/connections/${topicId}?limit=20`);
                const data = await response.json();
                
                if (data.connections) {
                    list.innerHTML = '';
                    
                    if (data.connections.length === 0) {
                        list.innerHTML = '<div class="error">–°–≤—è–∑–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                        return;
                    }
                    
                    data.connections.forEach(connection => {
                        const connectionItem = document.createElement('div');
                        connectionItem.className = 'connection-item';
                        connectionItem.innerHTML = `
                            <div class="connection-strength">${connection.connection_strength}%</div>
                            <div class="connection-name">
                                <div style="color: ${connection.color}; font-weight: bold;">${connection.name}</div>
                                <div class="connection-metrics">
                                    ${connection.co_mention_count} —Å–æ–≤–º–µ—Å—Ç–Ω—ã—Ö —É–ø–æ–º–∏–Ω–∞–Ω–∏–π ‚Ä¢ 
                                    Score: ${connection.avg_score.toFixed(2)}
                                </div>
                            </div>
                        `;
                        list.appendChild(connectionItem);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–µ–π:', error);
                list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–µ–π</div>';
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞–Ω–∞–ª—ã —Å–æ–±—ã—Ç–∏—è
        async function showEventChannels(clusterId, eventTitle) {
            currentTopicId = clusterId;
            const modal = document.getElementById('connections-modal');
            const title = document.getElementById('connections-title');
            const list = document.getElementById('connections-list');
            
            title.textContent = `–ö–∞–Ω–∞–ª—ã —Å–æ–±—ã—Ç–∏—è "${eventTitle}"`;
            modal.style.display = 'block';
            list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–∞–ª–æ–≤...</div>';
            
            try {
                const response = await fetch(`/pro/api/trends/channels/${clusterId}?period=${currentPeriod}&limit=20`);
                const data = await response.json();
                
                if (data.channels) {
                    list.innerHTML = '';
                    
                    if (data.channels.length === 0) {
                        list.innerHTML = '<div class="error">–ö–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                        return;
                    }
                    
                    data.channels.forEach(channel => {
                        const channelItem = document.createElement('div');
                        channelItem.className = 'connection-item';
                        channelItem.innerHTML = `
                            <div class="connection-strength">${(channel.event_activity_score || 0).toFixed(1)}</div>
                            <div class="connection-name">
                                <div style="font-weight: bold;">${channel.name}</div>
                                <div class="connection-metrics">
                                    @${channel.username || 'N/A'} ‚Ä¢ 
                                    ${channel.event_messages || 0} —Å–æ–æ–±—â–µ–Ω–∏–π ‚Ä¢ 
                                    ${formatNumber(channel.total_views || 0)} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                                </div>
                            </div>
                        `;
                        list.appendChild(channelItem);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤:', error);
                list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤</div>';
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞–Ω–∞–ª—ã —Ç–µ–º—ã (legacy –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        async function showTopicChannels(topicId, topicName) {
            currentTopicId = topicId;
            const modal = document.getElementById('connections-modal');
            const title = document.getElementById('connections-title');
            const list = document.getElementById('connections-list');
            
            title.textContent = `–ö–∞–Ω–∞–ª—ã —Ç–µ–º—ã "${topicName}"`;
            modal.style.display = 'block';
            list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–∞–ª–æ–≤...</div>';
            
            try {
                const response = await fetch(`/pro/api/trends/channels/topic/${topicId}?period=${currentPeriod}&limit=20`);
                const data = await response.json();
                
                if (data.channels) {
                    list.innerHTML = '';
                    
                    if (data.channels.length === 0) {
                        list.innerHTML = '<div class="error">–ö–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                        return;
                    }
                    
                    data.channels.forEach(channel => {
                        const channelItem = document.createElement('div');
                        channelItem.className = 'connection-item';
                        channelItem.innerHTML = `
                            <div class="connection-strength">${(channel.topic_activity_score || 0).toFixed(1)}</div>
                            <div class="connection-name">
                                <div style="font-weight: bold;">${channel.name}</div>
                                <div class="connection-metrics">
                                    @${channel.username || 'N/A'} ‚Ä¢ 
                                    ${channel.topic_messages || 0} —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —Ç–µ–º–µ ‚Ä¢ 
                                    ${formatNumber(channel.total_views || 0)} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                                </div>
                            </div>
                        `;
                        list.appendChild(channelItem);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤:', error);
                list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤</div>';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeConnectionsModal() {
            document.getElementById('connections-modal').style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
        document.getElementById('connections-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConnectionsModal();
            }
        });

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getPeriodText(period) {
            switch(period) {
                case 'daily': return '–¥–µ–Ω—å';
                case 'weekly': return '–Ω–µ–¥–µ–ª—é';
                case 'monthly': return '–º–µ—Å—è—Ü';
                default: return '–ø–µ—Ä–∏–æ–¥';
            }
        }

        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) {
                return '0';
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
