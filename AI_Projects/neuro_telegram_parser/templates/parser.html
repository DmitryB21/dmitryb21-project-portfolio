<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–æ–º Telegram</title>
    <link rel="stylesheet" href="{{ url_for('send_static', path='style.css') }}?v=2.1">
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ */
        .search-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .search-container input {
            flex: 1;
        }
        
        .search-container button {
            padding: 8px 12px;
            min-width: auto;
        }
        
        .search-results {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .search-results h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }
        
        .search-results-list {
            margin-bottom: 15px;
        }
        
        .search-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .search-item input[type="checkbox"] {
            margin-right: 10px;
        }
        
        .search-item label {
            flex: 1;
            cursor: pointer;
        }
        
        .search-item strong {
            display: block;
            margin-bottom: 4px;
        }
        
        .search-item small {
            color: #666;
        }
        
        .search-actions {
            text-align: center;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #218838;
        }
        
        .btn-success:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ */
        .popular-channels {
            margin: 15px 0;
        }
        
        .channel-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .channel-tag {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .channel-tag:hover {
            background: #e9ecef;
            border-color: #007bff;
        }
        
        .channel-tag input[type="checkbox"] {
            margin-right: 6px;
            margin: 0;
        }
        
        .channel-tag input[type="checkbox"]:checked + span {
            font-weight: bold;
            color: #007bff;
        }
        
        .channel-tag:has(input:checked) {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .custom-channel-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .custom-channel-container input {
            flex: 1;
        }
        
        .selected-channels {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .selected-channels h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }
        
        .selected-channels-list {
            margin-bottom: 15px;
        }
        
        .selected-channel-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .selected-channel-info {
            flex: 1;
        }
        
        .selected-channel-name {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .selected-channel-username {
            font-size: 12px;
            color: #666;
        }
        
        .remove-channel-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-channel-btn:hover {
            background: #c82333;
        }
        
        .selected-channels-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        .parse-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã */
        .system-health {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .system-health h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        
        .health-status {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .health-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            min-width: 150px;
        }
        
        .health-label {
            font-weight: bold;
            color: #333;
        }
        
        .health-indicator {
            font-size: 14px;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .health-indicator.ok {
            background: #d4edda;
            color: #155724;
        }
        
        .health-indicator.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .health-indicator.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .health-indicator.loading {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .health-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–¥–∞—á */
        .monitoring-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tasks-table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        .tasks-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .tasks-table th,
        .tasks-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tasks-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .tasks-table tr:hover {
            background: #f8f9fa;
        }
        
        .task-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .task-status.queued {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .task-status.running {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .task-status.completed {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .task-status.failed {
            background: #ffebee;
            color: #c62828;
        }
        
        .progress-cell {
            min-width: 200px;
        }
        
        .progress-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .progress-bar {
            position: relative;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8em;
            font-weight: 600;
            color: #333;
        }
        
        .progress-stage {
            font-size: 0.85em;
            color: #666;
        }
        
        .progress-details {
            font-size: 0.8em;
            color: #888;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 0.8em;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–µ—Å—Å–∏–∏ */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }
        
        .close:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .session-step {
            margin-bottom: 20px;
        }
        
        .session-step h4 {
            color: #007bff;
            margin-bottom: 10px;
        }
        
        .session-step p {
            color: #666;
            margin-bottom: 15px;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        #session-success {
            text-align: center;
            color: #28a745;
        }
        
        #session-error {
            text-align: center;
            color: #dc3545;
        }
        
        #session-error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ—à–∏—Ä–∏–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .full-width {
            grid-column: 1;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Å—Å–∏–∏ */
        .session-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 2px solid #dee2e6;
        }
        
        .session-info {
            flex: 1;
        }
        
        .session-status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .session-status-indicator span:first-child {
            font-size: 1.5em;
        }
        
        .session-status-indicator span:last-child {
            font-size: 1.1em;
            font-weight: 600;
            color: #495057;
        }
        
        .session-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-top: 10px;
        }
        
        .session-details p {
            margin: 5px 0;
            color: #666;
        }
        
        .session-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .session-info-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-bottom: 15px;
        }
        
        .session-info-display p {
            margin: 0;
            color: #495057;
        }
        
        .form-help {
            display: block;
            margin-top: 5px;
            font-size: 0.85em;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–æ–º Telegram</h1>
            <div class="header-actions">
                <a href="/pro/" class="btn-pro">üöÄ Pro-—Ä–µ–∂–∏–º</a>
            </div>
        </div>
        
        <div class="grid-container">
            <!-- 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Å—Å–∏–∏ Telegram -->
            <div class="card full-width">
                <h2>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Å—Å–∏–∏ Telegram</h2>
                
                <div class="session-status">
                    <div id="session-info" class="session-info">
                        <div class="session-status-indicator">
                            <span id="session-status-icon">‚ùå</span>
                            <span id="session-status-text">–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞</span>
                        </div>
                        <div id="session-details" class="session-details" style="display: none;">
                            <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> <span id="session-user-name">-</span></p>
                            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="session-user-phone">-</span></p>
                            <p><strong>Username:</strong> <span id="session-user-username">-</span></p>
                        </div>
                    </div>
                    <div class="session-actions">
                        <button id="setup-session-btn" class="btn-warning">üîê –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
                        <button id="test-session-btn" class="btn-secondary" style="display: none;">üîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
                    </div>
                </div>
            </div>
            
            <!-- 2. –ü–∞—Ä—Å–∏–Ω–≥ –∏–∑ —Ñ–∞–π–ª–∞ -->
            <div class="card">
                <h2>2. –ü–∞—Ä—Å–∏–Ω–≥ –∏–∑ —Ñ–∞–π–ª–∞</h2>
                
                <div class="form-group">
                    <label for="source-files">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª-–∏—Å—Ç–æ—á–Ω–∏–∫:</label>
                    <select id="source-files" name="source-files"></select>
                </div>
                
                <div id="file-info" class="info-box" style="display: none;">
                    <p><span class="label">–í—Å–µ–≥–æ –∫–∞–Ω–∞–ª–æ–≤ –≤ —Ñ–∞–π–ª–µ:</span> <span id="total-channels">0</span></p>
                </div>
                
                <div class="form-group">
                    <label for="channel-limit">–õ–∏–º–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤:</label>
                    <input type="number" id="channel-limit" name="channel-limit" value="10" min="1" max="100">
                    <small class="form-help">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞</small>
                </div>
                
                <div class="form-group">
                    <label for="parse-limit">–õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –∫–∞–Ω–∞–ª:</label>
                    <input type="number" id="parse-limit" name="parse-limit" value="100" min="1" max="10000">
                </div>
                
                <div class="form-group">
                    <label for="parse-days">–ü–µ—Ä–∏–æ–¥ –ø–∞—Ä—Å–∏–Ω–≥–∞ (–¥–Ω–µ–π –Ω–∞–∑–∞–¥):</label>
                    <select id="parse-days" name="parse-days">
                        <option value="1">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å</option>
                        <option value="3">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è</option>
                        <option value="7" selected>–ó–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é</option>
                        <option value="14">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏</option>
                        <option value="30">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü</option>
                        <option value="90">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞</option>
                        <option value="0">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</option>
                    </select>
                    <small class="form-help">–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</small>
                </div>
                
                <button id="parse-btn" class="btn-primary">üöÄ –ù–∞—á–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥</button>
                
                <div id="parse-status" class="status-box" style="display: none;">
                    <div class="status-header">
                        <span class="status-icon">‚è≥</span>
                        <span class="status-text">–ü–∞—Ä—Å–∏–Ω–≥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="parse-progress"></div>
                    </div>
                    <div class="status-details">
                        <p>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∫–∞–Ω–∞–ª–æ–≤: <span id="processed-channels">0</span> / <span id="total-channels-count">0</span></p>
                        <p>–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: <span id="total-messages">0</span></p>
                    </div>
                </div>
            </div>
            
            <!-- 3. –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤ -->
            <div class="card">
                <h2>3. –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤</h2>
                
                <div class="form-group">
                    <label for="search-query">–ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ –∫–ª—é—á–µ–≤–æ–º—É —Å–ª–æ–≤—É:</label>
                    <div class="search-container">
                        <input type="text" id="search-query" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤...">
                        <button id="search-channels-btn" class="btn-primary">üîç –ù–∞–π—Ç–∏ –∫–∞–Ω–∞–ª—ã</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤:</label>
                    <div class="popular-channels">
                        <div class="channel-tags">
                            <label class="channel-tag">
                                <input type="checkbox" value="@mash" data-channel-name="Mash">
                                <span>@mash</span>
                            </label>
                            <label class="channel-tag">
                                <input type="checkbox" value="@readovkanews" data-channel-name="Readovka News">
                                <span>@readovkanews</span>
                            </label>
                            <label class="channel-tag">
                                <input type="checkbox" value="@rian_ru" data-channel-name="–†–ò–ê –ù–æ–≤–æ—Å—Ç–∏">
                                <span>@rian_ru</span>
                            </label>
                            <label class="channel-tag">
                                <input type="checkbox" value="@bazabazon" data-channel-name="Baza">
                                <span>@bazabazon</span>
                            </label>
                            <label class="channel-tag">
                                <input type="checkbox" value="@ostorozhno_novosti" data-channel-name="–û—Å—Ç–æ—Ä–æ–∂–Ω–æ, –Ω–æ–≤–æ—Å—Ç–∏">
                                <span>@ostorozhno_novosti</span>
                            </label>
                            <label class="channel-tag">
                                <input type="checkbox" value="@toporlive" data-channel-name="–¢–æ–ø–æ—Ä Live">
                                <span>@toporlive</span>
                            </label>
                            <label class="channel-tag">
                                <input type="checkbox" value="@moscowachnews" data-channel-name="–ú–æ—Å–∫–≤–∞—á News">
                                <span>@moscowachnews</span>
                            </label>
                            <label class="channel-tag">
                                <input type="checkbox" value="@smi_rf_moskva" data-channel-name="–°–ú–ò –†–§ –ú–æ—Å–∫–≤–∞">
                                <span>@smi_rf_moskva</span>
                            </label>
                            <label class="channel-tag">
                                <input type="checkbox" value="@shot_shot" data-channel-name="Shot">
                                <span>@shot_shot</span>
                            </label>
                            <label class="channel-tag">
                                <input type="checkbox" value="@tassagency" data-channel-name="–¢–ê–°–°">
                                <span>@tassagency</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="custom-channel">–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –∫–∞–Ω–∞–ª:</label>
                    <div class="custom-channel-container">
                        <input type="text" id="custom-channel" placeholder="@channel_name –∏–ª–∏ https://t.me/channel_name">
                        <button id="add-custom-channel-btn" class="btn-secondary">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
                
                <div id="search-results" class="search-results" style="display: none;">
                    <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:</h4>
                    <div id="search-results-list" class="search-results-list">
                        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                <div class="search-actions">
                    <div class="parse-settings">
                        <div class="form-group">
                            <label for="search-results-parse-days">–ü–µ—Ä–∏–æ–¥ –ø–∞—Ä—Å–∏–Ω–≥–∞ (–¥–Ω–µ–π –Ω–∞–∑–∞–¥):</label>
                            <select id="search-results-parse-days" name="search-results-parse-days">
                                <option value="1">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å</option>
                                <option value="3">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è</option>
                                <option value="7" selected>–ó–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é</option>
                                <option value="14">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏</option>
                                <option value="30">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü</option>
                                <option value="90">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞</option>
                                <option value="0">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="search-results-parse-limit">–õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –∫–∞–Ω–∞–ª:</label>
                            <input type="number" id="search-results-parse-limit" name="search-results-parse-limit" value="100" min="1" max="10000">
                        </div>
                    </div>
                    <button id="parse-selected-channels-btn" class="btn-success" disabled>üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
                </div>
                </div>
                
                <div id="selected-channels" class="selected-channels" style="display: none;">
                    <h4>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞:</h4>
                    <div id="selected-channels-list" class="selected-channels-list">
                        <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                    </div>
                    <div class="selected-channels-actions">
                        <div class="parse-settings">
                            <div class="form-group">
                                <label for="search-parse-days">–ü–µ—Ä–∏–æ–¥ –ø–∞—Ä—Å–∏–Ω–≥–∞ (–¥–Ω–µ–π –Ω–∞–∑–∞–¥):</label>
                                <select id="search-parse-days" name="search-parse-days">
                                    <option value="1">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å</option>
                                    <option value="3">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è</option>
                                    <option value="7" selected>–ó–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é</option>
                                    <option value="14">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏</option>
                                    <option value="30">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü</option>
                                    <option value="90">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞</option>
                                    <option value="0">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="search-parse-limit">–õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –∫–∞–Ω–∞–ª:</label>
                                <input type="number" id="search-parse-limit" name="search-parse-limit" value="100" min="1" max="10000">
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button id="parse-selected-custom-btn" class="btn-success">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
                            <button id="clear-selected-btn" class="btn-secondary">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="card">
                <h2>4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-messages-stat">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-channels-stat">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –∫–∞–Ω–∞–ª–æ–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="last-update-stat">-</div>
                        <div class="stat-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
                    </div>
                </div>
                
                <button id="refresh-stats-btn" class="btn-secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
            </div>
            
            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Å—Å–∏–∏ -->
            <div id="session-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Å—Å–∏–∏ Telegram</h3>
                        <span class="close" onclick="closeSessionModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div id="session-step-0" class="session-step">
                            <h4>–®–∞–≥ 0: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</h4>
                            <p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ API Telegram:</p>
                            <div class="form-group">
                                <label for="modal-api-id">API ID:</label>
                                <input type="text" id="modal-api-id" placeholder="–í–≤–µ–¥–∏—Ç–µ API ID" required>
                            </div>
                            <div class="form-group">
                                <label for="modal-api-hash">API Hash:</label>
                                <input type="password" id="modal-api-hash" placeholder="–í–≤–µ–¥–∏—Ç–µ API Hash" required>
                            </div>
                            <div class="form-group">
                                <label for="modal-phone-number">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                                <input type="tel" id="modal-phone-number" placeholder="+7XXXXXXXXXX" required>
                            </div>
                            <button id="save-api-settings-btn" class="btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API</button>
                        </div>
                        
                        <div id="session-step-1" class="session-step" style="display: none;">
                            <h4>–®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h4>
                            <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞ –Ω–∞ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</p>
                            <div class="session-info-display">
                                <p><strong>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</strong> <span id="display-phone">-</span></p>
                            </div>
                            <button id="send-code-btn" class="btn-primary">üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</button>
                        </div>
                        
                        <div id="session-step-2" class="session-step" style="display: none;">
                            <h4>–®–∞–≥ 2: –í–≤–æ–¥ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h4>
                            <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—à–µ–ª –≤ Telegram:</p>
                            <div class="form-group">
                                <label for="session-code">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
                                <input type="text" id="session-code" placeholder="12345" maxlength="5" required>
                            </div>
                            <button id="verify-code-btn" class="btn-primary">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
                            <button id="resend-code-btn" class="btn-secondary">üîÑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ</button>
                        </div>
                        
                        <div id="session-step-3" class="session-step" style="display: none;">
                            <h4>–®–∞–≥ 3: –ü–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)</h4>
                            <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:</p>
                            <div class="form-group">
                                <label for="session-password">–ü–∞—Ä–æ–ª—å 2FA:</label>
                                <input type="password" id="session-password" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å 2FA">
                            </div>
                            <button id="verify-password-btn" class="btn-primary">üîí –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                        </div>
                        
                        <div id="session-result" class="session-step" style="display: none;">
                            <div id="session-success" style="display: none;">
                                <h4>‚úÖ –°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</h4>
                                <p>–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram API.</p>
                            </div>
                            <div id="session-error" style="display: none;">
                                <h4>‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏</h4>
                                <p id="session-error-message"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–¥–∞—á -->
            <div class="card">
                <h2>5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–¥–∞—á</h2>
                
                <!-- –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã -->
                <div class="system-health">
                    <h3>üîß –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</h3>
                    <div class="health-status">
                        <div class="health-item">
                            <span class="health-label">Qdrant:</span>
                            <span id="qdrant-status" class="health-indicator">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                        </div>
                        <div class="health-item">
                            <span class="health-label">Redis:</span>
                            <span id="redis-status" class="health-indicator">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                        </div>
                        <div class="health-item">
                            <span class="health-label">PostgreSQL:</span>
                            <span id="postgres-status" class="health-indicator">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                        </div>
                    </div>
                    <div class="health-actions">
                        <button id="check-health-btn" class="btn-secondary">üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
                        <button id="auto-refresh-btn" class="btn-primary">üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
                    </div>
                </div>
                
                <div class="monitoring-controls">
                    <button id="refresh-tasks-btn" class="btn-secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button id="clear-completed-btn" class="btn-warning">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</button>
                </div>
                
                <div class="tasks-table-container">
                    <table class="tasks-table">
                        <thead>
                            <tr>
                                <th>ID –∑–∞–¥–∞—á–∏</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                                <th>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</th>
                                <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="tasks-table-body">
                            <!-- –ó–∞–¥–∞—á–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        document.addEventListener('DOMContentLoaded', function() {
            loadSourceFiles();
            loadStats();
            loadTasks();
            checkSessionStatus();
            
            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–Ω–æ–ø–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–¥–∞—á
            const refreshTasksBtn = document.getElementById('refresh-tasks-btn');
            if (refreshTasksBtn) {
                refreshTasksBtn.addEventListener('click', loadTasks);
            }
            
            const clearCompletedBtn = document.getElementById('clear-completed-btn');
            if (clearCompletedBtn) {
                clearCompletedBtn.addEventListener('click', async function() {
                    if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (completed, failed, cancelled)?')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/v1/tasks/clear-completed', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            alert(`‚úÖ ${data.message || '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –æ—á–∏—â–µ–Ω—ã'}`);
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
                            loadTasks();
                        } else {
                            const error = await response.json();
                            alert(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∑–∞–¥–∞—á: ${error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∑–∞–¥–∞—á:', error);
                        alert('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∑–∞–¥–∞—á: ' + error.message);
                    }
                });
            }
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                loadTasks();
            }, 5000);
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        async function loadSourceFiles() {
            try {
                const response = await fetch('/api/v1/sources/files');
                const data = await response.json();
                
                const select = document.getElementById('source-files');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª...</option>';
                
                if (data.files && data.files.length > 0) {
                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file;
                        option.textContent = file;
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                    option.disabled = true;
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:', error);
                const select = document.getElementById('source-files');
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤</option>';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        document.getElementById('source-files').addEventListener('change', function() {
            const selectedFile = this.value;
            if (selectedFile) {
                loadFileInfo(selectedFile);
            } else {
                document.getElementById('file-info').style.display = 'none';
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ
        async function loadFileInfo(filename) {
            try {
                const response = await fetch(`/api/v1/sources/file-info?filename=${filename}`);
                const info = await response.json();
                
                document.getElementById('total-channels').textContent = info.total_channels;
                document.getElementById('file-info').style.display = 'block';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ:', error);
            }
        }

        // –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞
        document.getElementById('parse-btn').addEventListener('click', async function() {
            const selectedFile = document.getElementById('source-files').value;
            const limit = document.getElementById('parse-limit').value;
            const channelLimit = document.getElementById('channel-limit').value;
            const parseDays = document.getElementById('parse-days').value;
            
            if (!selectedFile) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª-–∏—Å—Ç–æ—á–Ω–∏–∫');
                return;
            }
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–∏–Ω–≥–∞
                document.getElementById('parse-status').style.display = 'block';
                document.getElementById('parse-btn').disabled = true;
                
                const response = await fetch('/api/v1/parse/from-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source_file: selectedFile,
                        limit_per_channel: parseInt(limit),
                        channel_limit: parseInt(channelLimit),
                        days_back: parseInt(parseDays)
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω:', result);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    loadStats();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + error.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + error.message);
            } finally {
                document.getElementById('parse-status').style.display = 'none';
                document.getElementById('parse-btn').disabled = false;
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('total-messages-stat').textContent = stats.total_messages || 0;
                document.getElementById('total-channels-stat').textContent = stats.total_channels || 0;
                document.getElementById('last-update-stat').textContent = stats.last_update || '-';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        document.getElementById('refresh-stats-btn').addEventListener('click', loadStats);


        // –ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ –∫–ª—é—á–µ–≤–æ–º—É —Å–ª–æ–≤—É
        document.getElementById('search-channels-btn').addEventListener('click', async function() {
            const query = document.getElementById('search-query').value.trim();
            
            if (!query) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }
            
            const searchResultsDiv = document.getElementById('search-results');
            const searchResultsList = document.getElementById('search-results-list');
            const parseSelectedBtn = document.getElementById('parse-selected-channels-btn');
            
            searchResultsDiv.style.display = 'block';
            searchResultsList.innerHTML = '<div style="text-align: center; padding: 20px;"><i>–ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤...</i></div>';
            parseSelectedBtn.disabled = true;
            
            try {
                const response = await fetch(`/api/v1/search/channels?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const resultsHtml = data.results.map((channel, index) => `
                        <div class="search-item">
                            <input type="checkbox" id="search-channel-${index}" data-channel-data='${JSON.stringify(channel)}'>
                            <label for="search-channel-${index}">
                                <strong>${channel.title}</strong>
                                ${channel.username ? `(@${channel.username})` : ''}
                                <small>ID: ${channel.id}</small>
                            </label>
                        </div>
                    `).join('');
                    
                    searchResultsList.innerHTML = resultsHtml;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
                    document.querySelectorAll('#search-results-list input[type="checkbox"]').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const checkedBoxes = document.querySelectorAll('#search-results-list input[type="checkbox"]:checked');
                            document.getElementById('parse-selected-channels-btn').disabled = checkedBoxes.length === 0;
                        });
                    });
                } else {
                    searchResultsList.innerHTML = '<div style="text-align: center; padding: 20px;"><i>–ö–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</i></div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                searchResultsList.innerHTML = '<div style="text-align: center; padding: 20px; color: red;"><i>–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤.</i></div>';
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
        document.querySelectorAll('.channel-tag input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectedChannels();
            });
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–∞–Ω–∞–ª–∞
        document.getElementById('add-custom-channel-btn').addEventListener('click', function() {
            const customChannel = document.getElementById('custom-channel').value.trim();
            if (!customChannel) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞');
                return;
            }
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–∞–Ω–∞–ª–∞
            let channelName = customChannel;
            if (customChannel.startsWith('https://t.me/')) {
                channelName = '@' + customChannel.replace('https://t.me/', '');
            } else if (!customChannel.startsWith('@')) {
                channelName = '@' + customChannel;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–Ω–∞–ª –≤ —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
            addChannelToSelected(channelName, channelName.replace('@', ''));
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('custom-channel').value = '';
        });

        // –ü–æ–∏—Å–∫ –ø–æ Enter –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–∞–Ω–∞–ª–∞
        document.getElementById('custom-channel').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('add-custom-channel-btn').click();
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
        function updateSelectedChannels() {
            const selectedChannelsDiv = document.getElementById('selected-channels');
            const selectedChannelsList = document.getElementById('selected-channels-list');
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
            const selectedChannels = [];
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
            document.querySelectorAll('.channel-tag input[type="checkbox"]:checked').forEach(checkbox => {
                selectedChannels.push({
                    username: checkbox.value,
                    name: checkbox.dataset.channelName
                });
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã (–∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞)
            const customChannels = selectedChannelsDiv.dataset.customChannels ? 
                JSON.parse(selectedChannelsDiv.dataset.customChannels) : [];
            selectedChannels.push(...customChannels);
            
            if (selectedChannels.length > 0) {
                selectedChannelsDiv.style.display = 'block';
                
                const channelsHtml = selectedChannels.map((channel, index) => `
                    <div class="selected-channel-item">
                        <div class="selected-channel-info">
                            <div class="selected-channel-name">${channel.name}</div>
                            <div class="selected-channel-username">${channel.username}</div>
                        </div>
                        <button class="remove-channel-btn" onclick="removeSelectedChannel(${index})">‚úï</button>
                    </div>
                `).join('');
                
                selectedChannelsList.innerHTML = channelsHtml;
            } else {
                selectedChannelsDiv.style.display = 'none';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞ –≤ —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
        function addChannelToSelected(username, name) {
            const selectedChannelsDiv = document.getElementById('selected-channels');
            const customChannels = selectedChannelsDiv.dataset.customChannels ? 
                JSON.parse(selectedChannelsDiv.dataset.customChannels) : [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª
            const exists = customChannels.some(ch => ch.username === username) ||
                          document.querySelector(`.channel-tag input[value="${username}"]:checked`);
            
            if (!exists) {
                customChannels.push({ username, name });
                selectedChannelsDiv.dataset.customChannels = JSON.stringify(customChannels);
                updateSelectedChannels();
            } else {
                alert('–≠—Ç–æ—Ç –∫–∞–Ω–∞–ª —É–∂–µ –≤—ã–±—Ä–∞–Ω');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
        function removeSelectedChannel(index) {
            const selectedChannelsDiv = document.getElementById('selected-channels');
            const customChannels = selectedChannelsDiv.dataset.customChannels ? 
                JSON.parse(selectedChannelsDiv.dataset.customChannels) : [];
            
            if (index < customChannels.length) {
                customChannels.splice(index, 1);
                selectedChannelsDiv.dataset.customChannels = JSON.stringify(customChannels);
                updateSelectedChannels();
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
        document.getElementById('clear-selected-btn').addEventListener('click', function() {
            // –°–Ω–∏–º–∞–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã
            document.querySelectorAll('.channel-tag input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã
            const selectedChannelsDiv = document.getElementById('selected-channels');
            selectedChannelsDiv.dataset.customChannels = '[]';
            
            updateSelectedChannels();
        });

        // –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ (–ø–æ–ø—É–ª—è—Ä–Ω—ã–µ + –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ)
        document.getElementById('parse-selected-custom-btn').addEventListener('click', async function() {
            const selectedChannelsDiv = document.getElementById('selected-channels');
            const customChannels = selectedChannelsDiv.dataset.customChannels ? 
                JSON.parse(selectedChannelsDiv.dataset.customChannels) : [];
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
            const channelsToParse = [];
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
            document.querySelectorAll('.channel-tag input[type="checkbox"]:checked').forEach(checkbox => {
                channelsToParse.push({
                    username: checkbox.value,
                    name: checkbox.dataset.channelName
                });
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã
            channelsToParse.push(...customChannels);
            
            if (channelsToParse.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞');
                return;
            }
            
            const parseDays = document.getElementById('search-parse-days').value;
            const messageLimit = parseInt(document.getElementById('search-parse-limit').value) || 100;
            
            try {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–∞–Ω–∞–ª—ã –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è API
                const channelsForAPI = channelsToParse.map(channel => ({
                    username: channel.username,
                    name: channel.name
                }));
                
                const response = await fetch('/api/v1/parse/from-usernames', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        channels: channelsForAPI,
                        limit_per_channel: messageLimit,
                        days_back: parseInt(parseDays)
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω –¥–ª—è ${channelsToParse.length} –∫–∞–Ω–∞–ª–æ–≤!\n–ó–∞–¥–∞—á–∞ ID: ${data.task_id}`);
                    
                    // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä
                    document.getElementById('clear-selected-btn').click();
                } else {
                    alert(`–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞');
            }
        });

        // –ü–æ–∏—Å–∫ –ø–æ Enter
        document.getElementById('search-query').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('search-channels-btn').click();
            }
        });

        // –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
        document.getElementById('parse-selected-channels-btn').addEventListener('click', async function() {
            const checkedBoxes = document.querySelectorAll('#search-results-list input[type="checkbox"]:checked');
            
            if (checkedBoxes.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞');
                return;
            }
            
            const channelsToParse = Array.from(checkedBoxes).map(cb => {
                const channelData = JSON.parse(cb.dataset.channelData);
                return {
                    id: channelData.id,
                    name: channelData.title,
                    username: channelData.username,
                    access_hash: channelData.access_hash
                };
            });
            
            const parseDays = document.getElementById('search-results-parse-days').value;
            const messageLimit = parseInt(document.getElementById('search-results-parse-limit').value) || 100;
            
            try {
                const response = await fetch('/api/v1/parse/from-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        channels: channelsToParse,
                        limit_per_channel: messageLimit,
                        days_back: parseInt(parseDays)
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω –¥–ª—è ${channelsToParse.length} –∫–∞–Ω–∞–ª–æ–≤!\n–ó–∞–¥–∞—á–∞ ID: ${data.task_id}`);
                    
                    // –û—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
                    document.getElementById('search-results').style.display = 'none';
                    document.getElementById('search-query').value = '';
                } else {
                    alert(`–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞');
            }
        });


        // === –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–¥–∞—á ===
        
        // –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã
        let autoRefreshInterval = null;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
        async function checkSystemHealth() {
            const qdrantStatus = document.getElementById('qdrant-status');
            const redisStatus = document.getElementById('redis-status');
            const postgresStatus = document.getElementById('postgres-status');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–∑–∞–≥—Ä—É–∑–∫–∞"
            qdrantStatus.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
            qdrantStatus.className = 'health-indicator loading';
            redisStatus.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
            redisStatus.className = 'health-indicator loading';
            postgresStatus.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
            postgresStatus.className = 'health-indicator loading';
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Qdrant
                try {
                    const qdrantResponse = await fetch('/api/health/qdrant');
                    const qdrantData = await qdrantResponse.json();
                    if (qdrantResponse.ok && qdrantData.status === 'ok') {
                        qdrantStatus.textContent = '‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç';
                        qdrantStatus.className = 'health-indicator ok';
                    } else {
                        qdrantStatus.textContent = '‚ùå –û—à–∏–±–∫–∞';
                        qdrantStatus.className = 'health-indicator error';
                    }
                } catch (error) {
                    qdrantStatus.textContent = '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                    qdrantStatus.className = 'health-indicator error';
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Redis
                try {
                    const redisResponse = await fetch('/api/health/redis');
                    const redisData = await redisResponse.json();
                    if (redisResponse.ok && redisData.status === 'ok') {
                        redisStatus.textContent = '‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç';
                        redisStatus.className = 'health-indicator ok';
                    } else {
                        redisStatus.textContent = '‚ùå –û—à–∏–±–∫–∞';
                        redisStatus.className = 'health-indicator error';
                    }
                } catch (error) {
                    redisStatus.textContent = '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                    redisStatus.className = 'health-indicator error';
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º PostgreSQL
                try {
                    const postgresResponse = await fetch('/api/health/postgres');
                    const postgresData = await postgresResponse.json();
                    if (postgresResponse.ok && postgresData.status === 'ok') {
                        postgresStatus.textContent = '‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç';
                        postgresStatus.className = 'health-indicator ok';
                    } else {
                        postgresStatus.textContent = '‚ùå –û—à–∏–±–∫–∞';
                        postgresStatus.className = 'health-indicator error';
                    }
                } catch (error) {
                    postgresStatus.textContent = '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                    postgresStatus.className = 'health-indicator error';
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã:', error);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('check-health-btn').addEventListener('click', checkSystemHealth);
        
        document.getElementById('auto-refresh-btn').addEventListener('click', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                this.textContent = 'üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
                this.className = 'btn-primary';
            } else {
                autoRefreshInterval = setInterval(checkSystemHealth, 30000); // –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                this.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                this.className = 'btn-warning';
            }
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemHealth();
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á
        async function loadTasks() {
            try {
                const response = await fetch('/api/v1/tasks/list');
                const data = await response.json();
                
                const tbody = document.getElementById('tasks-table-body');
                tbody.innerHTML = '';
                
                if (data.tasks && data.tasks.length > 0) {
                    data.tasks.forEach(task => {
                        const row = createTaskRow(task);
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</td></tr>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∑–∞–¥–∞—á–∏
        function createTaskRow(task) {
            const row = document.createElement('tr');
            row.id = `task-${task.task_id}`;
            
            const startTime = task.start_time ? new Date(task.start_time).toLocaleString() : '-';
            const duration = task.duration ? formatDuration(task.duration) : '-';
            
            row.innerHTML = `
                <td class="task-id">${task.task_id}</td>
                <td><span class="task-status ${task.status}">${getStatusText(task.status)}</span></td>
                <td class="progress-cell">${createProgressBar(task.progress)}</td>
                <td>${startTime}</td>
                <td>${duration}</td>
                <td class="task-controls">
                    <button class="btn-small btn-info" onclick="showTaskDetails('${task.task_id}')">–î–µ—Ç–∞–ª–∏</button>
                    ${task.status === 'running' ? `<button class="btn-small btn-danger" onclick="cancelTask('${task.task_id}')">–û—Ç–º–µ–Ω–∞</button>` : ''}
                </td>
            `;
            
            return row;
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
        function createProgressBar(progress) {
            if (!progress || typeof progress !== 'object') {
                return '<div class="progress-container"><div class="progress-stage">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>';
            }
            
            const percentage = progress.percentage || 0;
            const stage = progress.stage || '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            const details = progress.details || '';
            
            return `
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percentage}%"></div>
                        <div class="progress-text">${percentage}%</div>
                    </div>
                    <div class="progress-stage">${stage}</div>
                    ${details ? `<div class="progress-details">${details}</div>` : ''}
                </div>
            `;
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
        function getStatusText(status) {
            const statusMap = {
                'queued': '–í –æ—á–µ—Ä–µ–¥–∏',
                'running': '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è',
                'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                'failed': '–û—à–∏–±–∫–∞',
                'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
            };
            return statusMap[status] || status;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        function formatDuration(seconds) {
            if (!seconds) return '-';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}—á ${minutes}–º ${secs}—Å`;
            } else if (minutes > 0) {
                return `${minutes}–º ${secs}—Å`;
            } else {
                return `${secs}—Å`;
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏
        function showTaskDetails(taskId) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            alert(`–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏ ${taskId} - —Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`);
        }
        
        // –û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á–∏
        async function cancelTask(taskId) {
            if (!confirm(`–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É ${taskId}?`)) {
                return;
            }
            
            try {
                // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å API –¥–ª—è –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏
                alert('–§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏');
            }
        }
        
        
        // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–µ–π Telegram ===
        
        let sessionState = {
            apiId: '',
            apiHash: '',
            phone: '',
            phoneCodeHash: '',
            currentStep: 0
        };
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Å—Å–∏–∏
        async function checkSessionStatus() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏
                const response = await fetch('/api/session/status');
                
                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ HTTP –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Å—Å–∏–∏:', response.status);
                    updateSessionStatus(false);
                    return;
                }
                
                const data = await response.json();
                
                if (data.exists && data.user) {
                    updateSessionStatus(true, data.user);
                } else {
                    console.log('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞:', data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                    updateSessionStatus(false);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Å—Å–∏–∏:', error);
                updateSessionStatus(false);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Å—Å–∏–∏
        function updateSessionStatus(isActive, userInfo = null) {
            const statusIcon = document.getElementById('session-status-icon');
            const statusText = document.getElementById('session-status-text');
            const sessionDetails = document.getElementById('session-details');
            const testBtn = document.getElementById('test-session-btn');
            
            if (isActive && userInfo) {
                statusIcon.textContent = '‚úÖ';
                statusText.textContent = '–°–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞';
                sessionDetails.style.display = 'block';
                document.getElementById('session-user-name').textContent = userInfo.first_name || '-';
                document.getElementById('session-user-phone').textContent = userInfo.phone_number || '-';
                document.getElementById('session-user-username').textContent = userInfo.username ? '@' + userInfo.username : '-';
                testBtn.style.display = 'inline-block';
            } else {
                statusIcon.textContent = '‚ùå';
                statusText.textContent = '–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞';
                sessionDetails.style.display = 'none';
                testBtn.style.display = 'none';
            }
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–µ—Å—Å–∏–∏
        document.getElementById('setup-session-btn').addEventListener('click', function() {
            document.getElementById('session-modal').style.display = 'flex';
            resetSessionModal();
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeSessionModal() {
            document.getElementById('session-modal').style.display = 'none';
            resetSessionModal();
        }
        
        // –°–±—Ä–æ—Å –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function resetSessionModal() {
            sessionState = { apiId: '', apiHash: '', phone: '', phoneCodeHash: '', currentStep: 0 };
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–ª–µ–≤–æ–π —à–∞–≥ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API)
            document.getElementById('session-step-0').style.display = 'block';
            document.getElementById('session-step-1').style.display = 'none';
            document.getElementById('session-step-2').style.display = 'none';
            document.getElementById('session-step-3').style.display = 'none';
            document.getElementById('session-result').style.display = 'none';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            document.getElementById('modal-api-id').value = '';
            document.getElementById('modal-api-hash').value = '';
            document.getElementById('modal-phone-number').value = '';
            document.getElementById('session-code').value = '';
            document.getElementById('session-password').value = '';
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ API
        document.getElementById('save-api-settings-btn').addEventListener('click', async function() {
            const apiId = document.getElementById('modal-api-id').value.trim();
            const apiHash = document.getElementById('modal-api-hash').value.trim();
            const phone = document.getElementById('modal-phone-number').value.trim();
            
            if (!apiId || !apiHash || !phone) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_id: apiId,
                        api_hash: apiHash,
                        phone_number: phone
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    sessionState.apiId = apiId;
                    sessionState.apiHash = apiHash;
                    sessionState.phone = phone;
                    
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É 1
                    document.getElementById('session-step-0').style.display = 'none';
                    document.getElementById('session-step-1').style.display = 'block';
                    document.getElementById('display-phone').textContent = phone;
                    sessionState.currentStep = 1;
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
            }
        });
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        document.getElementById('send-code-btn').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/session/send-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: sessionState.phone })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    sessionState.phoneCodeHash = data.phone_code_hash;
                    
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É 2
                    document.getElementById('session-step-1').style.display = 'none';
                    document.getElementById('session-step-2').style.display = 'block';
                    sessionState.currentStep = 2;
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞: ' + data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞');
            }
        });
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞
        document.getElementById('verify-code-btn').addEventListener('click', async function() {
            const code = document.getElementById('session-code').value.trim();
            
            if (!code) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
                return;
            }
            
            try {
                const response = await fetch('/api/session/verify-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: sessionState.phone,
                        code: code,
                        phone_code_hash: sessionState.phoneCodeHash
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.requires_password) {
                        // –ù—É–∂–µ–Ω –ø–∞—Ä–æ–ª—å 2FA
                        document.getElementById('session-step-2').style.display = 'none';
                        document.getElementById('session-step-3').style.display = 'block';
                        sessionState.currentStep = 3;
                    } else {
                        // –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ
                        showSessionResult(true);
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–æ–¥–∞: ' + data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–æ–¥–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–æ–¥–∞');
            }
        });
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è 2FA
        document.getElementById('verify-password-btn').addEventListener('click', async function() {
            const password = document.getElementById('session-password').value.trim();
            
            if (!password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
                return;
            }
            
            try {
                const response = await fetch('/api/session/verify-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: sessionState.phone,
                        password: password,
                        phone_code_hash: sessionState.phoneCodeHash
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSessionResult(true);
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è: ' + data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è');
            }
        });
        
        // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞
        document.getElementById('resend-code-btn').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/session/send-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: sessionState.phone })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    sessionState.phoneCodeHash = data.phone_code_hash;
                    alert('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ');
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏');
            }
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        function showSessionResult(success) {
            document.getElementById('session-step-0').style.display = 'none';
            document.getElementById('session-step-1').style.display = 'none';
            document.getElementById('session-step-2').style.display = 'none';
            document.getElementById('session-step-3').style.display = 'none';
            document.getElementById('session-result').style.display = 'block';
            
            if (success) {
                document.getElementById('session-success').style.display = 'block';
                document.getElementById('session-error').style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–∏
                setTimeout(() => {
                    checkSessionStatus();
                    closeSessionModal();
                }, 2000);
            } else {
                document.getElementById('session-success').style.display = 'none';
                document.getElementById('session-error').style.display = 'block';
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('session-modal');
            if (event.target === modal) {
                closeSessionModal();
            }
        });
    </script>
</body>
</html>
